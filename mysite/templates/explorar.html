{% extends 'layout.html' %}

{% block title %}Explorar Cuestionarios - DogeHoot{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('dashboard') }}">Inicio</a>
</li>
<li class="breadcrumb-item active" aria-current="page">Explorar</li>
{% endblock %}

{% block content %}

<!-- Sección: Categorías -->
<div class="explorar-categorias">
    <button class="categoria active" style="background-color: var(--btn-pending-bg); color: var(--btn-pending-text);"
        data-categoria="todos" onclick="filtrarPorCategoriaExplorar('todos')">
        Todas las Categorías
    </button>
    {% for cat in categorias %}
    <button class="categoria categoria-{{ loop.index % 6 }}" data-categoria="{{ cat.id_categoria }}"
        onclick="filtrarPorCategoriaExplorar('{{ cat.id_categoria }}')">
        {{ cat.categoria }}
    </button>
    {% endfor %}
</div>

<!-- Sección: Grid de Cuestionarios -->
<div class="explorar-grid">
    {% for c in cuestionarios %}
    <div class="card-quiz-explorar" data-categoria="{{ c.id_categoria }}" data-titulo="{{ c.titulo|lower }}"
        data-descripcion="{{ c.descripcion|lower }}">
        <div class="card-quiz__media">
            {% if c.imagen_portada %}
            <img src="{{ url_for('static', filename=c.imagen_portada) }}" alt="{{ c.titulo }}">
            {% else %}
            <img src="{{ url_for('static', filename='img/registro-aside.png') }}" alt="{{ c.titulo }}">
            {% endif %}
        </div>

        <div class="card-quiz__body">
            <h2 class="card-quiz__title">{{ c.titulo }}</h2>
            <p class="card-quiz__desc">{{ c.descripcion }}</p>

            <div class="card-quiz__footer">
                <div class="card-quiz__stats-row">
                    <div class="card-quiz__stat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span>{{ c.nombre_usuario }}</span>
                    </div>

                    <div class="card-quiz__stat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M6 3h9a3 3 0 0 1 3 3v11a2 2 0 0 1-2 2H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h10V6a1 1 0 0 0-1-1H6Zm3 4h5a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Zm0 4h5a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Z"
                                fill="currentColor" />
                        </svg>
                        <span>{{ c.categoria }}</span>
                    </div>
                </div>

                <div class="card-quiz__actions">
                    <button class="card-quiz__cta card-quiz__cta--play" type="button"
                        onclick="window.location.href='{{ url_for('configurar_partida', id_cuestionario=c.id_cuestionario) }}'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="100 150 320 220"
                            fill="none">
                            <path
                                d="M254,183.7h0c-72.82-1.22-101.38,22.29-111.25,39-14.72,24.92-27,81.37,7.64,102.23,10.92,6.57,25.37,3.09,37.4-5.82,19-14.09,41.81-22.21,65.49-22.21h5.46c23.68,0,46.47,8.12,65.49,22.21,12,8.91,26.48,12.39,37.4,5.82,34.67-20.86,22.36-77.31,7.64-102.23-9.87-16.72-38.43-40.23-111.25-39h-4Z"
                                stroke="currentColor" stroke-width="20" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path
                                d="M201.9,233.93V222.36a2.3,2.3,0,0,0-2.3-2.31H188a2.3,2.3,0,0,0-2.3,2.31v11.57a2.31,2.31,0,0,1-2.31,2.31H171.83a2.3,2.3,0,0,0-2.3,2.3v11.58a2.3,2.3,0,0,0,2.3,2.3h11.58a2.31,2.31,0,0,1,2.31,2.3V266.3a2.3,2.3,0,0,0,2.3,2.3H199.6a2.3,2.3,0,0,0,2.3-2.3V254.72a2.3,2.3,0,0,1,2.3-2.3h11.58a2.3,2.3,0,0,0,2.3-2.3V238.54a2.3,2.3,0,0,0-2.3-2.3H204.2A2.3,2.3,0,0,1,201.9,233.93Z"
                                fill="currentColor" />
                            <circle cx="328.06" cy="228.14" r="8.09" fill="currentColor" />
                            <circle cx="328.06" cy="260.51" r="8.09" fill="currentColor" />
                            <circle cx="344.24" cy="244.33" r="8.09" fill="currentColor" />
                            <circle cx="311.87" cy="244.33" r="8.09" fill="currentColor" />
                        </svg>
                        Jugar!
                    </button>

                    <form id="formClonarExp{{ c.id_cuestionario }}" method="POST"
                        action="/cuestionarios/clonar/{{ c.id_cuestionario }}" style="display: inline;"
                        onsubmit="event.preventDefault(); confirmarClonarExplorar(event, '{{ c.titulo }}', {{ c.id_cuestionario }});">
                        <button class="card-quiz__cta card-quiz__cta--clone" type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Clonar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="sin-cuestionarios">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <p>No hay cuestionarios públicos disponibles en este momento.</p>
        <p class="subtitulo">Los profesores pueden crear cuestionarios públicos para compartir con todos.</p>
    </div>
    {% endfor %}
</div>

<!-- Modal de Confirmación para Clonar -->
<div id="modalClonarExplorar" class="modal-overlay">
    <div class="modal-contenido">
        <div class="modal-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <h2>¿Clonar Cuestionario?</h2>
        </div>

        <div class="modal-body">
            <p class="modal-titulo-cuestionario">"<span id="modalClonarTituloExplorar"></span>"</p>
            <p class="modal-descripcion">Se creará una copia en <strong>Mis Cuestionarios</strong> que podrás editar
                libremente.</p>
            <ul class="modal-lista">
                <li>✓ El cuestionario clonado será <strong>NO público</strong></li>
                <li>✓ Incluye todas las preguntas y opciones</li>
                <li>✓ Puedes editarlo y personalizarlo a tu gusto</li>
            </ul>
        </div>

        <div class="modal-footer">
            <button type="button" class="modal-btn modal-btn-cancelar" onclick="cerrarModalClonarExplorar()">
                Cancelar
            </button>
            <button type="button" class="modal-btn modal-btn-confirmar" onclick="confirmarClonarModalExplorar()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Sí, Clonar
            </button>
        </div>
    </div>
</div>

<script>
    // Detectar parámetro de búsqueda en la URL y sincronizar con input del NAV
    window.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const terminoBusqueda = urlParams.get('buscar');
        const inputNav = document.getElementById('inputBuscarNav');

        // Sincronizar el input del NAV con el término de búsqueda
        if (terminoBusqueda && inputNav) {
            inputNav.value = terminoBusqueda;
        }

        // Aplicar búsqueda inicial si viene de URL
        if (terminoBusqueda) {
            buscarEnExplorar(terminoBusqueda);
        }

        // Hacer que el input del NAV funcione en tiempo real
        if (inputNav) {
            inputNav.addEventListener('input', function () {
                const termino = this.value;
                buscarEnExplorar(termino);

                // Actualizar URL sin recargar página
                const nuevaUrl = termino
                    ? window.location.pathname + '?buscar=' + encodeURIComponent(termino)
                    : window.location.pathname;
                window.history.replaceState({}, '', nuevaUrl);
            });
        }
    });

    function buscarEnExplorar(termino) {
        const filtro = (termino || '').toLowerCase();
        const tarjetas = document.querySelectorAll('.card-quiz-explorar');

        tarjetas.forEach(tarjeta => {
            const titulo = tarjeta.dataset.titulo || '';
            const descripcion = tarjeta.dataset.descripcion || '';

            if (titulo.includes(filtro) || descripcion.includes(filtro)) {
                tarjeta.style.display = '';
            } else {
                tarjeta.style.display = 'none';
            }
        });
    }

    function filtrarPorCategoriaExplorar(idCategoria) {
        // Limpiar búsqueda al filtrar por categoría (tanto del NAV como del local si existiera)
        const inputNav = document.getElementById('inputBuscarNav');
        if (inputNav) {
            inputNav.value = '';
        }

        // Limpiar URL
        window.history.replaceState({}, '', window.location.pathname);

        document.querySelectorAll('.categoria').forEach(cat => {
            cat.classList.remove('active');
        });
        document.querySelector('[data-categoria="' + idCategoria + '"]').classList.add('active');

        const tarjetas = document.querySelectorAll('.card-quiz-explorar');
        tarjetas.forEach(tarjeta => {
            if (idCategoria === 'todos') {
                tarjeta.style.display = '';
            } else {
                if (tarjeta.dataset.categoria === String(idCategoria)) {
                    tarjeta.style.display = '';
                } else {
                    tarjeta.style.display = 'none';
                }
            }
        });
    }

    function confirmarClonarExplorar(event, titulo, idCuestionario) {
        event.preventDefault();

        // Mostrar modal de confirmación
        const modal = document.getElementById('modalClonarExplorar');
        const tituloElemento = document.getElementById('modalClonarTituloExplorar');
        tituloElemento.textContent = titulo;
        modal.style.display = 'flex';

        // Guardar el ID del formulario para enviarlo después
        window.idFormularioClonarExp = idCuestionario;

        return false;
    }

    function cerrarModalClonarExplorar() {
        const modal = document.getElementById('modalClonarExplorar');
        modal.style.display = 'none';
    }

    function confirmarClonarModalExplorar() {
        // Enviar el formulario guardado usando su ID
        if (window.idFormularioClonarExp) {
            const form = document.getElementById('formClonarExp' + window.idFormularioClonarExp);
            if (form) {
                cerrarModalClonarExplorar();
                form.submit();
            }
        } else {
            cerrarModalClonarExplorar();
        }
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function (event) {
        const modal = document.getElementById('modalClonarExplorar');
        if (event.target === modal) {
            cerrarModalClonarExplorar();
        }
    }
</script>

<style>
    /* Estilos para la página Explorar */
    .explorar-header {
        background: linear-gradient(135deg, #E6F2FF 0%, #F0F7FF 100%);
        border: 2px solid #1E88E5;
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 28px;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.12);
    }

    .explorar-titulo {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .explorar-titulo svg {
        color: #1E88E5;
    }

    .explorar-titulo h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1E88E5;
        margin: 0;
    }

    .explorar-buscador {
        position: relative;
        max-width: 600px;
    }

    .explorar-buscador .buscador-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9E9E9E;
        pointer-events: none;
    }

    .explorar-buscador .buscador-input {
        width: 100%;
        padding: 14px 14px 14px 42px;
        border: 2px solid #E0E0E0;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
        background: white;
    }

    .explorar-buscador .buscador-input:focus {
        outline: none;
        border-color: #1E88E5;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }

    .explorar-categorias {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 28px;
    }

    .explorar-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
    }

    @media (min-width: 768px) {
        .explorar-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .explorar-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1440px) {
        .explorar-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .card-quiz-explorar {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .card-quiz-explorar:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    /* Reutilizar estilos del modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6) !important;
        backdrop-filter: blur(4px);
        z-index: 9999 !important;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-contenido {
        background: #ffffff !important;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
        animation: slideUp 0.3s ease;
        overflow: hidden;
        position: relative;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%) !important;
        color: white !important;
        padding: 24px;
        text-align: center;
    }

    .modal-header svg {
        margin-bottom: 12px;
        color: white !important;
        stroke: white !important;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: white !important;
    }

    .modal-body {
        padding: 28px 24px;
        background: white !important;
    }

    .modal-titulo-cuestionario {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1E88E5;
        margin-bottom: 16px;
        text-align: center;
    }

    .modal-descripcion {
        color: #616161;
        font-size: 0.95rem;
        margin-bottom: 20px;
        text-align: center;
    }

    .modal-lista {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-lista li {
        padding: 10px 0;
        color: #424242;
        font-size: 0.9rem;
        border-bottom: 1px solid #F5F5F5;
    }

    .modal-lista li:last-child {
        border-bottom: none;
    }

    .modal-footer {
        padding: 20px 24px;
        background: #F9F9F9 !important;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .modal-btn-cancelar {
        background: white !important;
        color: #616161 !important;
        border-color: #E0E0E0 !important;
    }

    .modal-btn-cancelar:hover {
        background: #F5F5F5 !important;
        border-color: #BDBDBD !important;
    }

    .modal-btn-confirmar {
        background: #1E88E5 !important;
        color: white !important;
    }

    .modal-btn-confirmar:hover {
        background: #1565C0 !important;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
        transform: translateY(-1px);
    }

    .modal-btn-confirmar svg {
        width: 18px;
        height: 18px;
        stroke: white !important;
    }

    .sin-cuestionarios {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        background: #F5F5F5;
        border-radius: 20px;
    }

    .sin-cuestionarios svg {
        color: #9E9E9E;
        margin-bottom: 16px;
    }

    .sin-cuestionarios p {
        color: #616161;
        font-size: 1.1rem;
        margin: 8px 0;
    }

    .sin-cuestionarios .subtitulo {
        font-size: 0.95rem;
        color: #9E9E9E;
    }
</style>

{% endblock %}