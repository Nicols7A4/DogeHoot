{% extends "layout.html" %}

{% block title %}Inicio{% endblock %}

{% block breadcrumb %}
<li class="active">Inicio</li>
{% endblock %}

{% block content %}

<!-- Sección: Unirse a una sesión por código -->
<div class="codigo-acceso-dashboard">
    <div class="codigo-acceso-content">
        <div class="codigo-acceso-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <div>
                <h2>¿Tienes un código de sesión?</h2>
                <p>Únete a un cuestionario ingresando el código de 6 dígitos</p>
            </div>
        </div>

        <form class="codigo-form-dashboard" onsubmit="validarCodigoDashboard(event)">
            <input type="text" id="codigoInputDashboard" class="codigo-input-dashboard" placeholder="ABC123"
                maxlength="6" pattern="[A-Za-z0-9]{6}" required>
            <button type="submit" class="btn-codigo-dashboard" id="btnAccederDashboard">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="m12 5 7 7-7 7"></path>
                </svg>
                Unirse Ahora
            </button>
        </form>

        <div class="mensaje-error-dashboard" id="mensajeErrorDashboard"></div>
    </div>
</div>

<!-- Sección: Filtros por Categorías -->
<div class="div-categorias">
    <h1>Categorías</h1>
    <div class="categorias-container">
        <div class="categorias-lista">
            <div class="categoria in-progress active" data-categoria="todos" onclick="filtrarPorCategoria('todos')">
                Todos
            </div>
            {% for cat in categorias %}
            {% set colores = ['pending', 'submitted', 'success', 'failed', 'expired', 'in-progress'] %}
            {% set color_clase = colores[loop.index0 % 6] %}
            <div class="categoria {{ color_clase }}" data-categoria="{{ cat.id_categoria }}"
                onclick="filtrarPorCategoria({{ cat.id_categoria }})">
                {{ cat.categoria }}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Sección: Cuestionarios Populares -->
<div class="div-populares">
    <div class="populares-header">
        <h1>Cuestionarios Populares</h1>

        <div class="buscador-container">
            <svg class="buscador-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="buscadorCuestionarios" class="buscador-input" placeholder="Buscar cuestionarios..."
                onkeyup="buscarCuestionarios()">
        </div>
    </div>

    <div class="contenedor-cards">
        {% for c in cuestionarios %}
        <div class="card-quiz" data-categoria="{{ c.id_categoria }}" data-titulo="{{ c.titulo|lower }}"
            data-descripcion="{{ c.descripcion|lower }}">
            <div class="card-quiz__media">
                {% if c.imagen_portada %}
                <img src="{{ url_for('static', filename=c.imagen_portada) }}" alt="{{ c.titulo }}">
                {% else %}
                <img src="{{ url_for('static', filename='img/registro-aside.png') }}" alt="{{ c.titulo }}">
                {% endif %}
            </div>

            <div class="card-quiz__body">
                <h2 class="card-quiz__title">{{ c.titulo }}</h2>
                <p class="card-quiz__desc">{{ c.descripcion }}</p>

                <div class="card-quiz__footer">
                    <div class="card-quiz__stats-row">
                        <div class="card-quiz__stat">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span>{{ c.nombre_usuario }}</span>
                        </div>

                        <div class="card-quiz__stat">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M6 3h9a3 3 0 0 1 3 3v11a2 2 0 0 1-2 2H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h10V6a1 1 0 0 0-1-1H6Zm3 4h5a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Zm0 4h5a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2Z"
                                    fill="currentColor" />
                            </svg>
                            <span>{{ c.categoria }}</span>
                        </div>
                    </div>

                    <div class="card-quiz__actions">
                        {% if tipo_usuario == 'P' %}

                        <button class="card-quiz__cta card-quiz__cta--play" type="button"
                            onclick="window.location.href='{{ url_for('configurar_partida', id_cuestionario=c.id_cuestionario) }}'"
                            title="Jugar ahora">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="100 150 320 220"
                                fill="none">
                                <path
                                    d="M254,183.7h0c-72.82-1.22-101.38,22.29-111.25,39-14.72,24.92-27,81.37,7.64,102.23,10.92,6.57,25.37,3.09,37.4-5.82,19-14.09,41.81-22.21,65.49-22.21h5.46c23.68,0,46.47,8.12,65.49,22.21,12,8.91,26.48,12.39,37.4,5.82,34.67-20.86,22.36-77.31,7.64-102.23-9.87-16.72-38.43-40.23-111.25-39h-4Z"
                                    stroke="currentColor" stroke-width="20" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M201.9,233.93V222.36a2.3,2.3,0,0,0-2.3-2.31H188a2.3,2.3,0,0,0-2.3,2.31v11.57a2.31,2.31,0,0,1-2.31,2.31H171.83a2.3,2.3,0,0,0-2.3,2.3v11.58a2.3,2.3,0,0,0,2.3,2.3h11.58a2.31,2.31,0,0,1,2.31,2.3V266.3a2.3,2.3,0,0,0,2.3,2.3H199.6a2.3,2.3,0,0,0,2.3-2.3V254.72a2.3,2.3,0,0,1,2.3-2.3h11.58a2.3,2.3,0,0,0,2.3-2.3V238.54a2.3,2.3,0,0,0-2.3-2.3H204.2A2.3,2.3,0,0,1,201.9,233.93Z"
                                    fill="currentColor" />
                                <circle cx="328.06" cy="228.14" r="8.09" fill="currentColor" />
                                <circle cx="328.06" cy="260.51" r="8.09" fill="currentColor" />
                                <circle cx="344.24" cy="244.33" r="8.09" fill="currentColor" />
                                <circle cx="311.87" cy="244.33" r="8.09" fill="currentColor" />
                            </svg>
                            Jugar!
                        </button>

                        <form id="formClonar{{ c.id_cuestionario }}" method="POST"
                            action="/cuestionarios/clonar/{{ c.id_cuestionario }}" style="display: inline;"
                            onsubmit="event.preventDefault(); confirmarClonar(event, '{{ c.titulo }}', {{ c.id_cuestionario }});">
                            <button class="card-quiz__cta card-quiz__cta--clone" type="submit"
                                title="Clonar a mis cuestionarios">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                Clonar
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="sin-cuestionarios">
            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p>No hay cuestionarios públicos disponibles en este momento.</p>
            <p class="subtitulo">Los profesores pueden crear cuestionarios públicos para compartir con todos.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de Confirmación para Clonar -->
<div id="modalClonar" class="modal-overlay">
    <div class="modal-contenido">
        <div class="modal-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <h2>¿Clonar Cuestionario?</h2>
        </div>

        <div class="modal-body">
            <p class="modal-titulo-cuestionario">"<span id="modalClonarTitulo"></span>"</p>
            <p class="modal-descripcion">Se creará una copia en <strong>Mis Cuestionarios</strong> que podrás editar
                libremente.</p>
            <ul class="modal-lista">
                <li>✓ El cuestionario clonado será <strong>NO público</strong></li>
                <li>✓ Incluye todas las preguntas y opciones</li>
                <li>✓ Puedes editarlo y personalizarlo a tu gusto</li>
            </ul>
        </div>

        <div class="modal-footer">
            <button type="button" class="modal-btn modal-btn-cancelar" onclick="cerrarModalClonar()">
                Cancelar
            </button>
            <button type="button" class="modal-btn modal-btn-confirmar" onclick="confirmarClonarModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Sí, Clonar
            </button>
        </div>
    </div>
</div>

<script>
    function buscarCuestionarios() {
        const input = document.getElementById('buscadorCuestionarios');
        const filtro = input.value.toLowerCase();
        const tarjetas = document.querySelectorAll('.card-quiz');

        tarjetas.forEach(tarjeta => {
            const titulo = tarjeta.dataset.titulo || '';
            const descripcion = tarjeta.dataset.descripcion || '';

            if (titulo.includes(filtro) || descripcion.includes(filtro)) {
                tarjeta.style.display = '';
            } else {
                tarjeta.style.display = 'none';
            }
        });
    }

    function filtrarPorCategoria(idCategoria) {
        // Limpiar búsqueda al filtrar por categoría
        document.getElementById('buscadorCuestionarios').value = '';

        document.querySelectorAll('.categoria').forEach(cat => {
            cat.classList.remove('active');
        });
        document.querySelector('[data-categoria="' + idCategoria + '"]').classList.add('active');

        const tarjetas = document.querySelectorAll('.card-quiz');
        tarjetas.forEach(tarjeta => {
            if (idCategoria === 'todos') {
                tarjeta.style.display = '';
            } else {
                if (tarjeta.dataset.categoria === String(idCategoria)) {
                    tarjeta.style.display = '';
                } else {
                    tarjeta.style.display = 'none';
                }
            }
        });
    }

    function validarCodigoDashboard(event) {
        event.preventDefault();
        const input = document.getElementById('codigoInputDashboard');
        const codigo = input.value.trim().toUpperCase();
        const mensajeError = document.getElementById('mensajeErrorDashboard');

        if (codigo.length !== 6) {
            input.classList.add('error');
            mensajeError.textContent = 'El código debe tener exactamente 6 caracteres';
            mensajeError.classList.add('show');
            setTimeout(function () {
                input.classList.remove('error');
            }, 400);
            return false;
        }

        window.location.href = '/lobby/' + codigo;
        return false;
    }

    function confirmarClonar(event, titulo, idCuestionario) {
        event.preventDefault();

        // Mostrar modal de confirmación
        const modal = document.getElementById('modalClonar');
        const tituloElemento = document.getElementById('modalClonarTitulo');
        tituloElemento.textContent = titulo;
        modal.style.display = 'flex';

        // Guardar el ID del formulario para enviarlo después
        window.idFormularioClonar = idCuestionario;

        return false;
    }

    function cerrarModalClonar() {
        const modal = document.getElementById('modalClonar');
        modal.style.display = 'none';
    }

    function confirmarClonarModal() {
        // Enviar el formulario guardado usando su ID
        if (window.idFormularioClonar) {
            const form = document.getElementById('formClonar' + window.idFormularioClonar);
            if (form) {
                cerrarModalClonar();
                form.submit();
            }
        } else {
            cerrarModalClonar();
        }
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function (event) {
        const modal = document.getElementById('modalClonar');
        if (event.target === modal) {
            cerrarModalClonar();
        }
    }
</script>

<style>
    /* ====== Estilos mejorados para Dashboard ====== */

    /* Código de acceso */
    .codigo-acceso-dashboard {
        background: linear-gradient(135deg, #E6F2FF 0%, #F0F7FF 100%);
        border: 2px solid #1E88E5;
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 32px;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.12);
        transition: all 0.3s ease;
    }

    .codigo-acceso-dashboard:hover {
        box-shadow: 0 6px 16px rgba(30, 136, 229, 0.18);
        transform: translateY(-2px);
    }

    .codigo-acceso-content {
        max-width: 100%;
    }

    .codigo-acceso-header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 20px;
    }

    .codigo-acceso-header svg {
        flex-shrink: 0;
        color: #1E88E5;
        margin-top: 4px;
    }

    .codigo-acceso-header h2 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1E88E5;
        margin: 0 0 6px 0;
    }

    .codigo-acceso-header p {
        font-size: 14px;
        color: #616161;
        margin: 0;
        line-height: 1.5;
    }

    .codigo-form-dashboard {
        display: flex;
        gap: 12px;
        align-items: stretch;
        flex-wrap: wrap;
    }

    .codigo-input-dashboard {
        flex: 1;
        min-width: 200px;
        padding: 16px 20px;
        border: 2px solid #E0E0E0;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        letter-spacing: 3px;
        text-align: center;
        text-transform: uppercase;
        transition: all 0.2s ease;
        background: #FFFFFF;
        font-family: 'Courier New', monospace;
    }

    .codigo-input-dashboard:focus {
        outline: none;
        border-color: #1E88E5;
        box-shadow: 0 0 0 4px rgba(30, 136, 229, 0.15);
        transform: scale(1.02);
    }

    .codigo-input-dashboard.error {
        border-color: #E53935;
        background: #FFE6E6;
        animation: shake 0.4s;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-8px);
        }

        75% {
            transform: translateX(8px);
        }
    }

    .btn-codigo-dashboard {
        padding: 16px 32px;
        background: #1E88E5;
        color: #FFFFFF;
        border: 2px solid #1E88E5;
        border-radius: 12px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 10px rgba(30, 136, 229, 0.3);
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-codigo-dashboard:hover {
        background: #1976D2;
        border-color: #1976D2;
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(30, 136, 229, 0.4);
    }

    .btn-codigo-dashboard:active {
        transform: translateY(0);
    }

    .mensaje-error-dashboard {
        margin-top: 12px;
        padding: 12px 16px;
        background: #FFE6E6;
        color: #E53935;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        display: none;
    }

    .mensaje-error-dashboard.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Categorías mejoradas */
    .div-categorias {
        margin-bottom: 32px;
    }

    .div-categorias h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 20px;
    }

    .categorias-lista {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .categoria {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: 2px solid transparent;
        box-shadow: var(--btn-shadow);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .categoria:hover {
        transform: translateY(-3px);
        box-shadow: var(--btn-hover-shadow);
    }

    .categoria:active {
        transform: translateY(-1px);
    }

    .categoria.active {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    /* Cuestionarios populares */
    .div-populares {
        margin-top: 32px;
    }

    .populares-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: wrap;
    }

    .populares-header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .buscador-container {
        position: relative;
        flex: 0 1 300px;
    }

    .buscador-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9E9E9E;
        pointer-events: none;
    }

    .buscador-input {
        width: 100%;
        padding: 12px 14px 12px 42px;
        border: 2px solid #E0E0E0;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        background: white;
    }

    .buscador-input:focus {
        outline: none;
        border-color: #1E88E5;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }

    .buscador-input::placeholder {
        color: #BDBDBD;
    }

    .sin-cuestionarios {
        text-align: center;
        padding: 60px 20px;
        background: #F5F5F5;
        border-radius: 20px;
        grid-column: 1 / -1;
    }

    .sin-cuestionarios svg {
        color: #9E9E9E;
        margin-bottom: 16px;
    }

    .sin-cuestionarios p {
        font-size: 1.1rem;
        color: #616161;
        margin: 8px 0;
        font-weight: 500;
    }

    .sin-cuestionarios .subtitulo {
        font-size: 14px;
        color: #9E9E9E;
        font-weight: 400;
    }

    /* Responsive */
    @media (min-width: 768px) {
        .codigo-form-dashboard {
            flex-wrap: nowrap;
        }

        .contenedor-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .contenedor-cards {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* ====== Modal de Confirmación ====== */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6) !important;
        backdrop-filter: blur(4px);
        z-index: 9999 !important;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-contenido {
        background: #ffffff !important;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
        animation: slideUp 0.3s ease;
        overflow: hidden;
        position: relative;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%) !important;
        color: white !important;
        padding: 24px;
        text-align: center;
    }

    .modal-header svg {
        margin-bottom: 12px;
        color: white !important;
        stroke: white !important;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: white !important;
    }

    .modal-body {
        padding: 28px 24px;
        background: white !important;
    }

    .modal-titulo-cuestionario {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1E88E5;
        margin-bottom: 16px;
        text-align: center;
    }

    .modal-descripcion {
        color: #616161;
        font-size: 0.95rem;
        margin-bottom: 20px;
        text-align: center;
    }

    .modal-lista {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-lista li {
        padding: 10px 0;
        color: #424242;
        font-size: 0.9rem;
        border-bottom: 1px solid #F5F5F5;
    }

    .modal-lista li:last-child {
        border-bottom: none;
    }

    .modal-footer {
        padding: 20px 24px;
        background: #F9F9F9 !important;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .modal-btn-cancelar {
        background: white !important;
        color: #616161 !important;
        border-color: #E0E0E0 !important;
    }

    .modal-btn-cancelar:hover {
        background: #F5F5F5 !important;
        border-color: #BDBDBD !important;
    }

    .modal-btn-confirmar {
        background: #1E88E5 !important;
        color: white !important;
    }

    .modal-btn-confirmar:hover {
        background: #1565C0 !important;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
        transform: translateY(-1px);
    }

    .modal-btn-confirmar svg {
        width: 18px;
        height: 18px;
        stroke: white !important;
    }
</style>

{% endblock %}