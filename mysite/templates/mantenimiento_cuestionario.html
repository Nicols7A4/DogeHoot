{% extends "layout.html" %}

{% block head %}
{{ super() }}
<style>
    html,
    body {
        height: 100%;
        overflow: hidden
    }

    :root {
        --vh: 100dvh;
        --bottom-nav-height: 60px;
        --action-bar-height: 50px
    }

    * {
        box-sizing: border-box
    }

    .editor-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        height: calc(var(--vh) - var(--bottom-nav-height) - var(--action-bar-height));
        padding: 0 .5rem 0;
        gap: .5rem
    }

    .topbar-tabs {
        display: flex;
        gap: .3rem;
        border-bottom: 1px solid var(--border-soft);
        align-items: center;
        padding-top: .5rem;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        flex-shrink: 0
    }

    .topbar-tabs::-webkit-scrollbar {
        display: none
    }

    .tab-btn {
        padding: .5rem .7rem;
        border: 1px solid var(--border-soft);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        background: #f8fbff;
        color: var(--text-color);
        font-weight: 600;
        cursor: pointer;
        font-size: .85rem;
        white-space: nowrap;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .tab-btn kbd {
        font-size: 0.65rem;
        padding: 0.1rem 0.3rem;
        opacity: 0.7;
    }

    .tab-btn.active {
        background: var(--panel-bg);
        box-shadow: var(--panel-shadow)
    }

    .tab-btn.active kbd {
        opacity: 1;
    }

    .bottom-action-bar {
        position: fixed;
        bottom: var(--bottom-nav-height);
        left: 0;
        right: 0;
        height: var(--action-bar-height);
        background: var(--panel-bg);
        border-top: 1px solid var(--border-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
        padding: 0 1rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, .08);
        z-index: 100
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .35rem;
        border: 2px solid transparent;
        border-radius: 10px;
        padding: .55rem .9rem;
        font-size: .85rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all .2s ease-in-out;
        white-space: nowrap;
        flex-shrink: 0
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--btn-hover-shadow)
    }

    .btn[disabled] {
        opacity: .55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none
    }

    .btn-success {
        background: var(--btn-success-bg);
        color: var(--btn-success-text)
    }

    .btn-success:hover {
        border-color: var(--btn-success-text)
    }

    .btn-secondary {
        background: var(--btn-expired-bg);
        color: var(--text-muted)
    }

    .btn-secondary:hover {
        border-color: var(--text-muted);
        background: #e9ecef
    }

    .btn-primary {
        background: var(--btn-inprogress-bg);
        color: var(--btn-inprogress-text)
    }

    .btn-primary:hover {
        border-color: var(--btn-inprogress-text)
    }

    /* Estilo para atajos de teclado */
    kbd {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        font-size: 0.75rem;
        font-family: 'Courier New', monospace;
        color: #333;
        background-color: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        margin-left: 0.3rem;
        vertical-align: middle;
    }

    .btn kbd {
        background-color: rgba(255, 255, 255, 0.2);
        color: inherit;
        border-color: rgba(255, 255, 255, 0.3);
    }

    .btn-success kbd {
        background-color: rgba(255, 255, 255, 0.25);
    }

    /* Animaci贸n de pulso para feedback del atajo */
    @keyframes pulse-save {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(0.95);
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
        }

        100% {
            transform: scale(1);
        }
    }

    .btn-save-pulse {
        animation: pulse-save 0.3s ease-in-out;
    }

    /* Tooltip para feedback de atajos */
    .keyboard-tooltip {
        position: fixed;
        bottom: calc(var(--bottom-nav-height) + var(--action-bar-height) + 10px);
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        z-index: 9999;
        pointer-events: none;
        animation: fadeInOut 2s ease-in-out forwards;
    }

    @keyframes fadeInOut {
        0% {
            opacity: 0;
            transform: translateX(-50%) translateY(10px);
        }

        10% {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        90% {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        100% {
            opacity: 0;
            transform: translateX(-50%) translateY(-10px);
        }
    }

    .btn-outline {
        background: #fff;
        border: 1px solid var(--border-soft);
        color: var(--text-color)
    }

    .btn-sm {
        padding: .45rem .6rem;
        font-size: .75rem
    }

    .views-wrapper {
        flex: 1;
        min-height: 0;
        display: grid;
        overflow: hidden
    }

    .view {
        display: none;
        min-height: 0;
        overflow: hidden
    }

    .view.active {
        display: grid;
        grid-template-rows: 1fr;
        min-height: 0;
        overflow: hidden
    }

    .card {
        background: var(--panel-bg);
        border-radius: 12px;
        box-shadow: var(--panel-shadow);
        border: 1px solid var(--border-soft);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%
    }

    .card-header {
        padding: .65rem .75rem;
        font-size: .9rem;
        font-weight: 700;
        color: var(--text-color);
        border-bottom: 1px solid var(--border-soft);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .4rem;
        flex-wrap: wrap;
        flex-shrink: 0
    }

    .card-body {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: .65rem .75rem;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 1rem
    }

    /* ========== DATOS GENERALES - VERSIN MVIL MEJORADA ========== */
    .form-grid {
        display: flex;
        flex-direction: column;
        gap: .85rem;
        padding-bottom: 1rem
    }

    .form-section {
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: .85rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .03)
    }

    .form-section-title {
        font-size: .85rem;
        font-weight: 800;
        color: var(--text-color);
        margin-bottom: .65rem;
        padding-bottom: .45rem;
        border-bottom: 2px solid #f0f4f8;
        display: flex;
        align-items: center;
        gap: .4rem
    }

    .form-section-title::before {
        content: '';
        width: 3px;
        height: 14px;
        background: var(--btn-inprogress-bg);
        border-radius: 2px
    }

    .form-row {
        display: flex;
        flex-direction: column;
        gap: .45rem
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: .35rem
    }

    .form-group label {
        font-weight: 700;
        color: var(--text-color);
        font-size: .8rem;
        display: flex;
        align-items: center;
        gap: .3rem
    }

    .form-group label::after {
        content: '*';
        color: var(--btn-failed-text);
        font-weight: 900;
        font-size: .85rem
    }

    .form-group.optional label::after {
        content: '(opcional)';
        color: var(--text-muted);
        font-weight: 500;
        font-size: .7rem;
        margin-left: auto
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: .65rem .75rem;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        background: #fdfdfd;
        font-family: 'Poppins', sans-serif;
        font-size: .85rem;
        transition: all .2s ease;
        -webkit-appearance: none;
        appearance: none
    }

    .form-control:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .15);
        background: var(--panel-bg)
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
        line-height: 1.5
    }

    .char-counter-container {
        display: flex;
        justify-content: flex-end;
        margin-top: .1rem
    }

    .char-counter {
        font-size: .7rem;
        font-weight: 600;
        color: var(--text-muted)
    }

    .char-counter.warning {
        color: var(--btn-pending-text)
    }

    .char-counter.limit {
        color: var(--btn-failed-text);
        font-weight: 700
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: .55rem;
        font-weight: 600;
        color: var(--text-color);
        padding: .75rem;
        background: #f8fbff;
        border-radius: 8px;
        border: 1px solid #e3eef9;
        cursor: pointer;
        transition: all .2s ease;
        font-size: .85rem
    }

    .form-check:hover {
        background: #f0f7ff;
        border-color: var(--btn-inprogress-text)
    }

    .form-check input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--btn-inprogress-bg);
        flex-shrink: 0
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--border-soft), transparent);
        margin: .4rem 0
    }

    /* ========== PREGUNTAS Y RESPUESTAS ========== */
    .section-title {
        font-weight: 800;
        color: var(--text-color);
        font-size: .85rem
    }

    .q-mobile-switch {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .35rem;
        margin-bottom: .5rem;
        background: #f5f8fc;
        padding: .3rem;
        border-radius: 8px;
        flex-shrink: 0
    }

    .q-mobile-switch .sw {
        border: 1px solid transparent;
        background: transparent;
        border-radius: 6px;
        padding: .5rem .65rem;
        font-weight: 700;
        text-align: center;
        cursor: pointer;
        font-size: .8rem;
        transition: all .2s ease
    }

    .q-mobile-switch .sw.active {
        background: #fff;
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 2px 8px rgba(30, 136, 229, .15)
    }

    .q-layout {
        display: flex;
        flex-direction: column;
        gap: .5rem;
        height: 100%;
        min-height: 0;
        flex: 1;
        overflow: hidden
    }

    .q-layout.show-sidebar .q-sidebar {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0
    }

    .q-layout.show-sidebar .q-canvas {
        display: none
    }

    .q-layout.show-editor .q-sidebar {
        display: none
    }

    .q-layout.show-editor .q-canvas {
        display: block;
        flex: 1;
        min-height: 0
    }

    .q-sidebar {
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: .3rem;
        padding-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: .5rem;
        scrollbar-gutter: stable;
        min-height: 0;
        flex: 1;
        -webkit-overflow-scrolling: touch
    }

    .slide-card {
        display: flex;
        flex-direction: column;
        gap: .45rem;
        padding: .6rem;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        transition: all .2s ease;
        flex-shrink: 0
    }

    .slide-card:active {
        transform: scale(.98)
    }

    .slide-card.active {
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .12);
        background: #f8fbff
    }

    .slide-thumb16x9 {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 6px;
        background: #f5f7ff;
        border: 1px solid var(--border-soft);
        overflow: hidden;
        display: block
    }

    .slide-thumb16x9 img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block
    }

    .slide-title-full {
        font-weight: 700;
        color: var(--text-color);
        line-height: 1.35;
        font-size: .85rem
    }

    .slide-row {
        display: flex;
        justify-content: flex-end
    }

    .iconbtn {
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        padding: .35rem .55rem;
        cursor: pointer;
        font-size: .75rem;
        font-weight: 600;
        transition: all .2s ease
    }

    .iconbtn:hover {
        background: #f6f8ff;
        border-color: var(--btn-failed-text);
        color: var(--btn-failed-text)
    }

    .q-canvas {
        background: linear-gradient(180deg, #fafcff 0%, #ffffff 100%);
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: .6rem;
        padding-bottom: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, .04);
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        display: block;
        -webkit-overflow-scrolling: touch;
        flex: 1
    }

    .q-header-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .45rem;
        align-items: center;
        margin-bottom: .55rem
    }

    .q-header-grid .mini {
        display: flex;
        flex-direction: column;
        gap: .2rem
    }

    .q-header-grid label {
        font-size: .7rem;
        color: var(--text-muted);
        font-weight: 700;
        margin: 0
    }

    .q-header-grid input {
        padding: .45rem .55rem;
        font-size: .8rem
    }

    .q-title {
        font-size: .85rem;
        font-weight: 800;
        color: var(--text-color);
        grid-column: 1 / -1;
        text-align: center;
        padding: .45rem;
        background: #f8fbff;
        border-radius: 6px
    }

    .question-box {
        border-radius: 10px;
        background: #fff;
        border: 1px solid var(--border-soft);
        padding: .65rem;
        margin-bottom: .65rem;
        display: grid;
        grid-template-rows: auto auto auto;
        row-gap: .6rem
    }

    .question-input {
        width: 100%;
        font-size: .9rem;
        font-weight: 700;
        padding: .55rem .7rem;
        border-radius: 8px;
        border: 1px dashed var(--border-soft);
        background: #fcfdff
    }

    .media-wrap {
        border-radius: 10px;
        border: 2px dashed #cfe3ff;
        background: #f7faff;
        padding: .6rem;
        position: relative;
        min-height: 120px;
        max-height: 180px;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .media-wrap.dragover {
        border-color: #1E88E5;
        background: #eef6ff
    }

    .media-empty {
        text-align: center;
        color: #5c7fb1;
        font-size: .8rem;
        padding: .45rem
    }

    .media-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #e8eef9
    }

    .media-controls {
        position: absolute;
        right: .45rem;
        bottom: .45rem;
        display: flex;
        gap: .35rem;
        flex-wrap: wrap
    }

    .answer-grid {
        margin-top: .15rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: .5rem
    }

    .answer-card {
        border-radius: 8px;
        border: 2px solid transparent;
        background: #fff;
        padding: .55rem .65rem;
        min-height: 65px;
        display: grid;
        grid-template-columns: 24px 1fr;
        grid-template-rows: auto auto;
        grid-template-areas: "shape input" "tools counter";
        column-gap: .45rem;
        row-gap: .35rem;
        align-items: center;
        transition: all .2s ease
    }

    .answer-card.correct {
        border-color: var(--btn-success-text);
        box-shadow: 0 0 0 3px rgba(23, 170, 118, .12)
    }

    .answer-shape {
        grid-area: shape;
        width: 22px;
        height: 22px;
        border-radius: 5px;
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
        font-size: .8rem
    }

    .answer-content {
        grid-area: input;
        display: flex;
        flex-direction: column;
        gap: .15rem
    }

    .answer-input {
        width: 100%;
        border: 1px solid var(--border-soft);
        border-radius: 6px;
        padding: .45rem .6rem;
        background: #fff;
        outline: none;
        font-size: .8rem
    }

    .answer-input::placeholder {
        color: #9aa7b5
    }

    .answer-tools {
        grid-area: tools;
        display: flex;
        gap: .3rem;
        align-items: center;
        flex-wrap: wrap
    }

    .answer-tools .btn-tool {
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 5px;
        padding: .25rem .45rem;
        cursor: pointer;
        font-size: .7rem;
        font-weight: 600;
        transition: all .2s ease
    }

    .answer-tools .btn-tool:hover {
        background: #f3f6ff
    }

    .answer-tools .btn-tool:first-child:hover {
        border-color: var(--btn-success-text);
        color: var(--btn-success-text)
    }

    .answer-tools .btn-tool:last-child:hover {
        border-color: var(--btn-failed-text);
        color: var(--btn-failed-text)
    }

    .counter-small {
        grid-area: counter;
        font-size: .65rem;
        color: var(--text-muted);
        font-weight: 600;
        text-align: right
    }

    .variant-red {
        background: #ffe9ea;
        border-color: #ffccd0
    }

    .variant-red .answer-shape {
        background: #E53935
    }

    .variant-blue {
        background: #eaf2ff;
        border-color: #cfe0ff
    }

    .variant-blue .answer-shape {
        background: #1E88E5
    }

    .variant-yellow {
        background: #fff7e2;
        border-color: #ffe7ab
    }

    .variant-yellow .answer-shape {
        background: #F9A825
    }

    .variant-green {
        background: #e6f6ef;
        border-color: #bfe9d8
    }

    .variant-green .answer-shape {
        background: #2E7D32
    }

    .add-more-zone {
        display: flex;
        justify-content: center;
        margin-top: .35rem
    }

    .add-more-btn {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .5rem .8rem;
        border-radius: 999px;
        border: 1px dashed var(--border-soft);
        background: #f7fbff;
        cursor: pointer;
        font-weight: 700;
        font-size: .75rem;
        transition: all .2s ease
    }

    .add-more-btn:hover {
        background: #eef6ff;
        border-color: var(--btn-inprogress-text)
    }

    .modo-visualizacion .form-control,
    .modo-visualizacion .form-select {
        background: #f5f5f5;
        border-color: #e0e0e0;
        color: #616161;
        cursor: not-allowed;
        pointer-events: none
    }

    .modo-visualizacion .card-header button {
        display: none !important
    }

    .popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
        padding: 1rem
    }

    .popup-box {
        background: var(--panel-bg);
        padding: 1.5rem;
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, .2);
        text-align: center;
        width: 90%;
        max-width: 420px;
        border: 1px solid var(--border-soft)
    }

    .popup-box p {
        margin: 0 0 1rem;
        font-size: .95rem;
        color: var(--text-color);
        line-height: 1.6
    }

    .popup-buttons {
        display: flex;
        justify-content: center;
        gap: .6rem;
        flex-wrap: wrap
    }

    /* --- TEST: Estilo para el bot贸n Importar Preguntas --- */
    .btn-importar {
        background: #1D6F42;
        color: white;
    }

    .btn-importar:hover {
        background: #165934;
        border-color: #1D6F42;
    }

    /* --- Estilos para el Modal de Importaci贸n --- */
    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 12px;
        min-width: 450px;
        max-width: 90vw;
        position: relative;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 10px;
    }

    .modal-content p {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .modal-content .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        color: #aaa;
        font-size: 28px;
        cursor: pointer;
        font-weight: bold;
    }

    .modal-content .form-group {
        margin-bottom: 15px;
    }

    .modal-content .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: .85rem;
    }

    .modal-content .form-group input[type="file"] {
        width: 100%;
        font-size: .85rem;
        padding: .5rem;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    /* Mensajes de feedback en el modal */
    .importar-mensaje {
        font-size: .85rem;
        font-weight: 600;
        padding: .75rem;
        border-radius: 8px;
        display: none;
        /* Oculto por defecto */
        margin-top: 15px;
    }

    .importar-mensaje.success {
        background-color: var(--btn-success-bg);
        color: var(--btn-success-text);
        display: block;
    }

    .importar-mensaje.error {
        background-color: var(--btn-failed-bg);
        color: var(--btn-failed-text);
        display: block;
    }

    /* Ocultar atajos de teclado en modo responsivo (m贸vil y tablet) */
    @media (max-width: 1023px) {
        kbd {
            display: none !important;
        }

        /* Tambi茅n ocultar el bot贸n de ayuda F1 en m贸vil */
        .bottom-action-bar button[onclick="mostrarAyudaAtajos()"] {
            display: none !important;
        }
    }

    /* ========== TABLET ========== */
    @media (min-width:768px) {
        .editor-container {
            padding: 0 .75rem 0;
            gap: .65rem;
            height: calc(var(--vh) - var(--bottom-nav-height) - var(--action-bar-height))
        }

        .topbar-tabs {
            gap: .45rem
        }

        .tab-btn {
            padding: .55rem .85rem;
            font-size: .9rem
        }

        .btn {
            padding: .6rem 1rem;
            font-size: .9rem
        }

        .card-header {
            padding: .8rem .95rem;
            font-size: .95rem
        }

        .card-body {
            padding: .8rem .95rem;
            padding-bottom: 1rem
        }

        .form-grid {
            gap: .95rem
        }

        .form-section {
            padding: 1.05rem
        }

        .form-group label {
            font-size: .85rem
        }

        .form-control,
        .form-select {
            padding: .75rem .85rem;
            font-size: .9rem
        }

        .q-header-grid {
            grid-template-columns: repeat(2, 1fr) 2fr;
            gap: .55rem
        }

        .q-title {
            grid-column: 3;
            text-align: right
        }

        .answer-grid {
            grid-template-columns: 1fr 1fr
        }

        .question-input {
            font-size: .95rem
        }
    }

    /* ========== DESKTOP ========== */
    @media (min-width:1024px) {
        .editor-container {
            padding: 0 1rem 0;
            gap: .75rem;
            height: calc(var(--vh) - var(--action-bar-height))
        }

        .topbar-tabs {
            padding-right: 1rem
        }

        .tab-btn {
            padding: .6rem 1rem;
            font-size: .95rem
        }

        .bottom-action-bar {
            position: static;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: flex-end;
            padding: 0 1rem;
            border-top: none;
            background: transparent;
            box-shadow: none;
            height: var(--action-bar-height)
        }

        .card-header {
            padding: 1rem 1.25rem
        }

        .card-body {
            padding: 1rem 1.25rem
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            align-content: start;
            padding-bottom: 0
        }

        .form-section {
            padding: 1.25rem
        }

        .form-section.full-width {
            grid-column: 1 / -1
        }

        .view.active {
            grid-template-rows: 1fr
        }

        .q-mobile-switch {
            display: none
        }

        .q-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            grid-template-rows: 1fr;
            gap: 1rem;
            flex-direction: row
        }

        .q-layout .q-sidebar {
            display: flex !important;
            border-right: 1px dashed var(--border-soft);
            padding-right: .5rem
        }

        .q-layout .q-canvas {
            display: block !important;
            padding: .75rem
        }

        .q-layout.show-sidebar .q-canvas {
            display: block !important
        }

        .q-layout.show-editor .q-sidebar {
            display: flex !important
        }

        .answer-grid {
            grid-template-columns: 1fr 1fr
        }

        .question-input {
            font-size: 1.05rem
        }

        .q-title {
            font-size: 1.1rem
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container {% if modo_visualizacion %}modo-visualizacion{% endif %}">
    <div class="topbar-tabs">
        <button id="tab-general" class="tab-btn active" type="button">
            Datos generales <kbd>Alt+1</kbd>
        </button>
        <button id="tab-preguntas" class="tab-btn" type="button">
            Preguntas y respuestas <kbd>Alt+2</kbd>
        </button>
    </div>

    <div class="views-wrapper">
        <div id="view-general" class="view active">
            <div class="card">
                <div class="card-header">
                    <span id="titulo-pagina" class="section-title"></span>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <!-- Secci贸n: Informaci贸n B谩sica -->
                        <div class="form-section">
                            <div class="form-section-title">Informaci贸n B谩sica</div>
                            <div class="form-group">
                                <label for="titulo">T铆tulo del Cuestionario</label>
                                <input type="text" id="titulo" class="form-control"
                                    placeholder="Ej: Introducci贸n a Python"
                                    oninput="actualizarDato('titulo', this.value)" maxlength="100" {% if
                                    modo_visualizacion %}readonly{% endif %}>
                            </div>
                            <div class="form-group">
                                <label for="id_categoria">Categor铆a</label>
                                <select id="id_categoria" class="form-select"
                                    onchange="actualizarDato('id_categoria', parseInt(this.value, 10))" {% if
                                    modo_visualizacion %}disabled{% endif %}>
                                    {% for cat in categorias %}
                                    <option value="{{ cat.id_categoria }}">{{ cat.categoria }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Secci贸n: Descripci贸n -->
                        <div class="form-section">
                            <div class="form-section-title">Descripci贸n</div>
                            <div class="form-group optional">
                                <label for="descripcion">Objetivo del Cuestionario</label>
                                <textarea id="descripcion" class="form-control"
                                    placeholder="Describe el prop贸sito y alcance de este cuestionario..."
                                    oninput="actualizarDato('descripcion', this.value)" maxlength="500" {% if
                                    modo_visualizacion %}readonly{% endif %}></textarea>
                                <div class="char-counter-container">
                                    <span id="descripcion-char-counter" class="char-counter">0 / 500</span>
                                </div>
                            </div>
                        </div>

                        <!-- Secci贸n: Configuraci贸n -->
                        <div class="form-section full-width">
                            <div class="form-section-title">Configuraci贸n de Visibilidad</div>
                            <label class="form-check">
                                <input type="checkbox" id="es_publico"
                                    onchange="actualizarDato('es_publico', this.checked)" {% if modo_visualizacion
                                    %}disabled{% endif %}>
                                <span>Hacer p煤blico este cuestionario para todos los usuarios</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-preguntas" class="view">
            <div class="card">
                <div class="card-header">
                    <span>Editor de preguntas</span>
                    {% if not modo_visualizacion %}
                    <div style="display:flex;gap:.3rem;flex-wrap:wrap">
                        <button class="btn btn-outline btn-sm" id="btn-volver-general" type="button">Volver</button>
                        <button class="btn btn-primary btn-sm" onclick="agregarPregunta()">A帽adir
                            <kbd>Ctrl+Q</kbd></button>
                        <!-- Test de bot贸n importar -->
                        <button class="btn btn-importar btn-sm" id="btn-abrir-modal-importar" type="button">Importar
                            Preguntas</button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="q-mobile-switch" id="qSwitch">
                        <div class="sw active" data-target="sidebar">Lista</div>
                        <div class="sw" data-target="editor">Editor</div>
                    </div>
                    <div class="q-layout show-sidebar" id="qlayout">
                        <aside class="q-sidebar" id="slides-sidebar"></aside>
                        <section class="q-canvas">
                            <div id="canvas-contenido"></div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TEST Importar Excel -->
<div class="popup-overlay" id="modal-importar-overlay" style="display: none;">
    <div class="popup-box" style="text-align: left; max-width: 520px;">
        <h3 style="text-align: center; margin-top: 0; color: var(--text-color);">Importar Preguntas</h3>
        <p style="text-align: center; margin-bottom: 1rem; font-size: 0.9rem;">
            Sube un archivo <code>.xlsx</code> con el formato correcto.
            Las preguntas <strong>reemplazar谩n</strong> las existentes en memoria.
        </p>
        <div style="background: #f0f7ff; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem;">
            <strong>Columnas requeridas:</strong>
            <ul style="margin: 0.5rem 0 0 1.2rem; padding: 0; line-height: 1.6;">
                <li><code>pregunta</code> - Texto de la pregunta</li>
                <li><code>opcion_1</code> a <code>opcion_4</code> - Las 4 opciones</li>
                <li><code>opcion_c_orrecta</code> - N煤mero (1-4) de la opci贸n correcta</li>
                <li><code>tiempo_segundos</code> - Tiempo (10-100 segundos)</li>
                <li><code>url_imagen</code> - URL de imagen (opcional)</li>
            </ul>
        </div>
        <p style="text-align: center; margin-bottom: 1.5rem;">
            <a href="{{ url_for('importarExcel.descargar_plantilla') }}"
                style="font-weight:600; color:var(--btn-inprogress-text); font-size: 0.95rem;">
                 Descargar plantilla de ejemplo
            </a>
        </p>
        <form id="form-importar-preguntas">
            <input type="hidden" name="id_cuestionario" id="import-cuestionario-id">
            <div class="form-group">
                <label for="archivo_excel_modal">Archivo Excel (.xlsx)</label>
                <input type="file" id="archivo_excel_modal" name="archivo_excel" class="form-control" accept=".xlsx"
                    required>
            </div>
            <div id="importar-mensaje" class="importar-mensaje"></div>
            <div class="popup-buttons" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" id="btn-cancelar-modal">Cancelar</button>
                <button type="submit" class="btn btn-success" id="btn-submit-importar">Subir y A帽adir</button>
            </div>
        </form>
    </div>
</div>

<!-- Barra de acciones inferior -->
<div class="bottom-action-bar">
    {% if not modo_visualizacion %}
    <button id="btn-save" class="btn btn-success" onclick="guardarTodo()" disabled>
        Guardar cambios <kbd>Ctrl+S</kbd>
    </button>
    <button id="btn-cancel" class="btn btn-secondary" onclick="cancelarTodo()" disabled>
        Cancelar <kbd>Ctrl+Z</kbd>
    </button>
    <button class="btn btn-secondary" onclick="mostrarAyudaAtajos()" title="Ver todos los atajos de teclado">
        <i class="fas fa-keyboard"></i> <kbd>F1</kbd>
    </button>
    {% else %}
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Ir al Dashboard</a>
    {% endif %}
</div>

<script id="boot-data" type="application/json">
{
    "CUESTIONARIO_ID": {{ (cuestionario_data.id_cuestionario if cuestionario_data else none) | tojson }},
    "MODO_VISUALIZACION": {{ (modo_visualizacion | default(false)) | tojson }},
    "DATOS_DESDE_SERVIDOR": {{ (cuestionario_data if cuestionario_data else none) | tojson }},
    "SESSION_USER_ID": {{ (session.user_id | default(none)) | tojson }}
}
</script>

<script>
    const __BOOT = JSON.parse(document.getElementById('boot-data')?.textContent || '{}');
    const CUESTIONARIO_ID = __BOOT.CUESTIONARIO_ID ?? null;
    const MODO_VISUALIZACION = !!__BOOT.MODO_VISUALIZACION;

    let cuestionarioData = { id_cuestionario: null, titulo: 'Nuevo Cuestionario', descripcion: '', id_categoria: 1, es_publico: false, id_usuario: __BOOT.SESSION_USER_ID, preguntas: [] };
    let originalCuestionarioData;
    let currentView = 'general';
    let currentIndex = 0;

    const datosDesdeServidor = __BOOT.DATOS_DESDE_SERVIDOR;
    if (datosDesdeServidor) { cuestionarioData = datosDesdeServidor; }

    function resolveAdjuntoSrc(adjunto) {
        if (!adjunto) return null;
        if (adjunto.startsWith('data:image')) return adjunto;
        if (adjunto.startsWith('http')) return encodeURI(adjunto);
        if (adjunto.startsWith('/static/')) return encodeURI(adjunto);
        if (adjunto.startsWith('img/')) return encodeURI('/static/' + adjunto);
        if (adjunto.startsWith('uploads/')) return encodeURI('/static/' + adjunto);
        if (!adjunto.includes('/')) {
            if (typeof CUESTIONARIO_ID === 'number' || (typeof CUESTIONARIO_ID === 'string' && CUESTIONARIO_ID)) {
                return encodeURI(`/static/img/cuestionarios/c_${CUESTIONARIO_ID}/${adjunto}`);
            }
            return encodeURI('/static/' + adjunto);
        }
        return encodeURI('/static/' + adjunto);
    }

    function updateResponsiveMode() {
        const isDesktop = window.matchMedia('(min-width:1024px)').matches;
        const lay = document.getElementById('qlayout');
        const switcher = document.getElementById('qSwitch');
        if (!lay) return;
        if (isDesktop) {
            lay.classList.remove('show-sidebar', 'show-editor');
            if (switcher) switcher.style.display = 'none';
        } else {
            if (!lay.classList.contains('show-sidebar') && !lay.classList.contains('show-editor')) lay.classList.add('show-sidebar');
            if (switcher) switcher.style.display = 'grid';
        }
    }

    // TEST EXCEL antes de DOMContentLoaded
    const cerrarModalImportar = () => {
        const modalOverlay = document.getElementById('modal-importar-overlay');
        if (modalOverlay) modalOverlay.style.display = 'none';
        const form = document.getElementById('form-importar-preguntas');
        if (form) form.reset();
        const msgDiv = document.getElementById('importar-mensaje');
        if (msgDiv) {
            msgDiv.style.display = 'none';
            msgDiv.textContent = '';
            msgDiv.className = 'importar-mensaje';
        }
        const btnSubmit = document.getElementById('btn-submit-importar');
        if (btnSubmit) btnSubmit.disabled = false;
    };

    // Funci贸n para ABRIR el modal con logs
    const abrirModalImportar = async () => { // Mantenemos async por si 'mostrarAlerta' es as铆ncrono

        if (!CUESTIONARIO_ID) { // Si es un cuestionario nuevo (ID es null)
            await mostrarAlerta("Crea y guarda primero un cuestionario para importar preguntas por EXCEL.");
            return; // 隆No continuar!
        }

        // El resto del c贸digo solo se ejecuta si CUESTIONARIO_ID S existe:
        const modalOverlay = document.getElementById('modal-importar-overlay');
        const inputIdCuestionario = document.getElementById('import-cuestionario-id');

        if (inputIdCuestionario) {
            inputIdCuestionario.value = CUESTIONARIO_ID;
        } else {
            console.error("隆ERROR! No se encontr贸 el input 'import-cuestionario-id'.");
            return;
        }

        if (modalOverlay) {
            modalOverlay.style.display = 'flex';
        } else {
            console.error("隆ERROR! No se encontr贸 el elemento 'modal-importar-overlay'.");
        }
    };

    async function subirImportacion(event) {
        event.preventDefault();
        console.log("Funci贸n subirImportacion ejecutada."); // Log de depuraci贸n

        const form = document.getElementById('form-importar-preguntas');
        const fileInput = document.getElementById('archivo_excel_modal');
        const messageDiv = document.getElementById('importar-mensaje');
        const submitButton = document.getElementById('btn-submit-importar');

        if (submitButton) submitButton.disabled = true;
        messageDiv.style.display = 'none';
        messageDiv.textContent = '';
        messageDiv.className = 'importar-mensaje';

        if (!fileInput.files || fileInput.files.length === 0) {
            messageDiv.textContent = 'Por favor, selecciona un archivo Excel.';
            messageDiv.className = 'importar-mensaje error';
            messageDiv.style.display = 'block';
            if (submitButton) submitButton.disabled = false;
            return;
        }

        const formData = new FormData(form);

        try {
            const response = await fetch("{{ url_for('importarExcel.importar_preguntas_ajax') }}", {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            // --- NUEVO COMPORTAMIENTO: Cargar en memoria SIN guardar autom谩ticamente ---
            if (response.ok && result.success) {
                // 1. REEMPLAZAR todas las preguntas existentes con las importadas
                if (result.preguntas_actualizadas && Array.isArray(result.preguntas_actualizadas)) {
                    // Normalizar numeraci贸n de preguntas y ELIMINAR IDs (son preguntas nuevas de importaci贸n)
                    const preguntasNormalizadas = result.preguntas_actualizadas.map((p, idx) => {
                        // 锔 CRTICO: Eliminar id_pregunta para que se trate como pregunta nueva
                        delete p.id_pregunta;

                        // Tambi茅n eliminar id_opcion de las opciones
                        if (p.opciones && Array.isArray(p.opciones)) {
                            p.opciones.forEach(op => {
                                delete op.id_opcion;
                            });
                        }

                        p.num_pregunta = idx + 1;
                        return p;
                    });

                    // REEMPLAZAR (no a帽adir) las preguntas en memoria
                    cuestionarioData.preguntas = preguntasNormalizadas;

                    // 2. IMPORTANTE: Actualizar tambi茅n originalCuestionarioData para reflejar
                    // el nuevo estado "base" (sin las preguntas antiguas)
                    // Pero NO sincronizamos con las nuevas para que se detecte como cambio pendiente
                    originalCuestionarioData.preguntas = [];

                    // 3. Marcar que hay cambios pendientes
                    onAnyChange();

                    console.log(`${preguntasNormalizadas.length} preguntas importadas y cargadas en memoria (pendientes de guardar).`);
                    console.log('[DEBUG] Preguntas sin IDs:', preguntasNormalizadas);
                }

                messageDiv.textContent = (result.message || 'Preguntas importadas con 茅xito.') +
                    ' Las preguntas han reemplazado las anteriores. Usa "Guardar cambios" para persistir en la base de datos.';
                messageDiv.className = 'importar-mensaje success';
                messageDiv.style.display = 'block';

                // 2. Cerrar modal y re-renderizar la UI
                setTimeout(() => {
                    cerrarModalImportar();
                    // Ir a la primera pregunta importada
                    currentIndex = cuestionarioData.preguntas.length > 0 ? 0 : 0;
                    renderQuestionsUI(true); // 隆Renderizar con las nuevas preguntas!
                    updateActionButtons(); // Actualizar botones (deber铆a mostrar "Guardar cambios" habilitado)
                }, 1500);

            } else {
                // Manejar errores de validaci贸n
                let errorMsg = result.error || 'Error desconocido del servidor.';

                // Si hay errores m煤ltiples, mostrarlos en lista
                if (result.errores && Array.isArray(result.errores)) {
                    errorMsg = result.error + '\n\n';
                    result.errores.forEach((err, idx) => {
                        errorMsg += `${idx + 1}. ${err}\n`;
                    });
                }

                messageDiv.textContent = errorMsg;
                messageDiv.className = 'importar-mensaje error';
                messageDiv.style.display = 'block';
                messageDiv.style.whiteSpace = 'pre-wrap'; // Permitir saltos de l铆nea
                messageDiv.style.textAlign = 'left'; // Alinear a la izquierda para listas
                if (submitButton) submitButton.disabled = false;
            }
        } catch (error) {
            console.error("Error en fetch:", error);
            messageDiv.textContent = 'Error de conexi贸n al intentar subir el archivo.';
            messageDiv.className = 'importar-mensaje error';
            messageDiv.style.display = 'block';
            if (submitButton) submitButton.disabled = false;
        }
    }

    //Lugar originar del DOM

    function hayCambios() { return JSON.stringify(cuestionarioData) !== JSON.stringify(originalCuestionarioData); }
    function onAnyChange() { updateActionButtons(); }
    function updateActionButtons() { const save = document.getElementById('btn-save'); const cancel = document.getElementById('btn-cancel'); if (!save || !cancel) return; const changed = hayCambios(); save.disabled = !changed; cancel.disabled = !changed; }

    function switchView(view) {
        currentView = view;
        document.getElementById('tab-general').classList.toggle('active', view === 'general');
        document.getElementById('tab-preguntas').classList.toggle('active', view === 'preguntas');
        document.getElementById('view-general').classList.toggle('active', view === 'general');
        document.getElementById('view-preguntas').classList.toggle('active', view === 'preguntas');
        if (view === 'general') renderGeneral(); else renderQuestionsUI(true);
    }

    function renderGeneral() {
        document.getElementById('titulo-pagina').textContent = cuestionarioData.titulo || 'Nuevo Cuestionario';
        document.getElementById('titulo').value = cuestionarioData.titulo;
        document.getElementById('descripcion').value = cuestionarioData.descripcion;
        document.getElementById('id_categoria').value = cuestionarioData.id_categoria;
        document.getElementById('es_publico').checked = cuestionarioData.es_publico;
        document.getElementById('descripcion').dispatchEvent(new Event('input'));
        updateActionButtons();
    }

    function renderQuestionsUI(scrollCanvasTop = false) {
        const sidebar = document.getElementById('slides-sidebar');
        const canvas = document.getElementById('canvas-contenido');
        sidebar.innerHTML = ''; canvas.innerHTML = '';
        cuestionarioData.preguntas.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'slide-card' + (i === currentIndex ? ' active' : '');
            card.onclick = () => { currentIndex = i; renderQuestionsUI(true); };
            const src = resolveAdjuntoSrc(p.adjunto);
            if (src) {
                const thumb = document.createElement('div'); thumb.className = 'slide-thumb16x9';
                const img = document.createElement('img'); img.src = src; img.alt = 'Miniatura';
                thumb.appendChild(img); card.appendChild(thumb);
            }
            const title = document.createElement('div'); title.className = 'slide-title-full';
            const texto = (p.pregunta && !/^Nueva Pregunta/.test(p.pregunta)) ? p.pregunta.trim() : `Pregunta ${i + 1}`;
            title.textContent = texto; card.appendChild(title);
            if (!MODO_VISUALIZACION) {
                const row = document.createElement('div'); row.className = 'slide-row';
                const del = document.createElement('button'); del.className = 'iconbtn'; del.textContent = 'Eliminar';
                del.onclick = async (ev) => { ev.stopPropagation(); if (await mostrarConfirmacion("驴Seguro que desea quitar esta pregunta?")) { cuestionarioData.preguntas.splice(i, 1); if (currentIndex >= cuestionarioData.preguntas.length) currentIndex = Math.max(0, cuestionarioData.preguntas.length - 1); onAnyChange(); renderQuestionsUI(true); } };
                row.appendChild(del); card.appendChild(row);
            }
            sidebar.appendChild(card);
            if (i === currentIndex) { setTimeout(() => card.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' }), 0); }
        });
        if (!MODO_VISUALIZACION) {
            const add = document.createElement('button'); add.className = 'btn btn-primary btn-sm'; add.style.marginTop = '.25rem';
            add.textContent = 'A帽adir pregunta'; add.onclick = agregarPregunta; sidebar.appendChild(add);
        }
        if (cuestionarioData.preguntas.length === 0) {
            const empty = document.createElement('div');
            empty.innerHTML = `<div style="display:grid;place-items:center;gap:.75rem;padding:2rem;border:1px dashed var(--border-soft);border-radius:12px;background:#fff;">
            <div class="q-title">A煤n no hay preguntas</div>
            ${MODO_VISUALIZACION ? '' : '<button class="btn btn-primary" onclick="agregarPregunta()">Crear la primera pregunta</button>'}
        </div>`;
            canvas.appendChild(empty); return;
        }
        const p = cuestionarioData.preguntas[currentIndex];
        const readonly = MODO_VISUALIZACION ? 'readonly' : '';
        const VARIANTS = ['variant-red', 'variant-blue', 'variant-yellow', 'variant-green'];
        const SHAPES = ['', '', '', ''];
        const cleanValue = (txt) => (!txt || /^Nueva (Pregunta|Opci贸n)/.test(txt)) ? '' : txt;
        const mediaSrc = resolveAdjuntoSrc(p.adjunto);
        const html = `
    <div class="q-header-grid">
      <div class="mini">
        <label for="puntaje-${currentIndex}">Puntos</label>
        <input type="number" id="puntaje-${currentIndex}" class="form-control inPuntos" placeholder="0" value="${p.puntaje_base ?? ''}" oninput="actualizarPregunta(${currentIndex},'puntaje_base',parseInt(this.value,10))" min="1" max="1000" ${readonly}>
      </div>
      <div class="mini">
        <label for="tiempo-${currentIndex}">Tiempo (s)</label>
        <input type="number" id="tiempo-${currentIndex}" class="form-control inTiempo" placeholder="0" value="${p.tiempo ?? ''}" oninput="actualizarPregunta(${currentIndex},'tiempo',parseInt(this.value,10))" min="10" max="100" ${readonly}>
      </div>
      <div class="q-title">Pregunta ${p.num_pregunta || (currentIndex + 1)}</div>
    </div>
    <div class="question-box">
      <div>
        <input type="text" class="question-input" placeholder="Escribe la pregunta aqu铆" value="${cleanValue(p.pregunta)}" oninput="actualizarPregunta(${currentIndex},'pregunta',this.value); updateCharCounter(this,'pregunta-counter-${currentIndex}')" maxlength="150" ${readonly}>
        <div class="char-counter-container"><span id="pregunta-counter-${currentIndex}" class="char-counter">0 / 150</span></div>
      </div>
      <div class="media-wrap" id="dropzone-${currentIndex}">
        ${mediaSrc ? `
          <img id="media-img-${currentIndex}" class="media-image" src="${mediaSrc}" alt="Imagen de la pregunta">
          ${MODO_VISUALIZACION ? '' : `
            <div class="media-controls">
              <label class="btn btn-outline btn-sm">Cambiar
                <input type="file" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">
              </label>
              <button class="btn btn-secondary btn-sm" onclick="quitarImagen(${currentIndex})">Eliminar</button>
            </div>
          `}
        `: `
          <div class="media-empty">
            <div style="font-weight:700;margin-bottom:.3rem;">A帽adir imagen</div>
            <label style="text-decoration:underline; cursor:pointer;">
              <input type="file" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">
              Subir archivo
            </label>
            <div style="font-size:.7rem;margin-top:.25rem;">o arrastra y suelta aqu铆</div>
          </div>
          ${MODO_VISUALIZACION ? '' : `<input type="file" id="hidden-file-${currentIndex}" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">`}
        `}
      </div>
      <div class="answer-grid">
        ${p.opciones.map((op, idx) => {
            const v = VARIANTS[idx % 4], shape = SHAPES[idx % 4], correctClass = op.es_correcta_bool ? 'correct' : ''; return `
          <div class="answer-card ${v} ${correctClass}">
            <div class="answer-shape">${shape}</div>
            <div class="answer-content">
              <input type="text" class="answer-input" placeholder="Escribe una respuesta" value="${cleanValue(op.opcion)}" oninput="actualizarOpcion(${currentIndex},${idx},'opcion',this.value); updateCharCounter(this,'opcion-counter-${currentIndex}-${idx}')" maxlength="100" ${readonly}>
            </div>
            <div class="answer-tools">
              ${MODO_VISUALIZACION ? '' : `
                <button class="btn-tool" title="Marcar como correcta" onclick="marcarOpcionCorrecta(${currentIndex},${idx})">Correcta</button>
                <button class="btn-tool" title="Eliminar opci贸n" onclick="eliminarOpcion(${currentIndex},${idx})">Eliminar</button>
              `}
            </div>
            <div class="counter-small" id="opcion-counter-${currentIndex}-${idx}">0 / 100</div>
          </div>`;
        }).join('')}
      </div>
      ${MODO_VISUALIZACION ? '' : `
      <div class="add-more-zone">
        <button class="add-more-btn" onclick="agregarOpcion(${currentIndex})">A帽adir m谩s respuestas</button>
      </div>`}
    </div>`;
        canvas.innerHTML = html;
        canvas.querySelectorAll('input[maxlength]').forEach(el => el.dispatchEvent(new Event('input')));
        if (!MODO_VISUALIZACION) initDropzone(`dropzone-${currentIndex}`, currentIndex);
        if (scrollCanvasTop) { const target = document.querySelector('.slide-card.active'); if (target) target.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); }
        updateActionButtons();
    }

    function initDropzone(id, idx) {
        const z = document.getElementById(id); if (!z) return;
        ['dragenter', 'dragover'].forEach(evn => z.addEventListener(evn, e => { e.preventDefault(); e.stopPropagation(); z.classList.add('dragover'); }));
        ['dragleave', 'drop'].forEach(evn => z.addEventListener(evn, e => { e.preventDefault(); e.stopPropagation(); z.classList.remove('dragover'); }));
        z.addEventListener('drop', e => { const f = e.dataTransfer?.files?.[0]; if (f) handleImageFile(f, idx); });
    }
    function handleImageFile(file, indexPregunta) { const r = new FileReader(); r.onload = e => { cuestionarioData.preguntas[indexPregunta].adjunto = e.target.result; onAnyChange(); renderQuestionsUI(false); }; r.readAsDataURL(file); }

    function actualizarDato(campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData[campo] = valor; onAnyChange(); } }
    function agregarPregunta() {
        if (MODO_VISUALIZACION) return;
        const cant = cuestionarioData.preguntas.length;
        // No incluir id_pregunta para preguntas nuevas (el servidor lo generar谩)
        cuestionarioData.preguntas.push({ pregunta: `Nueva Pregunta ${cant + 1}`, num_pregunta: cant + 1, puntaje_base: 1000, tiempo: 15, adjunto: null, opciones: [] });
        agregarOpcion(cuestionarioData.preguntas.length - 1);
        currentIndex = cuestionarioData.preguntas.length - 1;
        onAnyChange(); renderQuestionsUI(true);
    }
    function actualizarPregunta(index, campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData.preguntas[index][campo] = valor; onAnyChange(); } }
    async function eliminarPregunta(index) {
        if (MODO_VISUALIZACION) return;
        if (await mostrarConfirmacion("驴Seguro que desea quitar esta pregunta?")) {
            cuestionarioData.preguntas.splice(index, 1);
            if (currentIndex >= cuestionarioData.preguntas.length) currentIndex = Math.max(0, cuestionarioData.preguntas.length - 1);
            onAnyChange(); renderQuestionsUI(true);
        }
    }
    function convertirImagen(input, indexPregunta) { const file = input.files[0]; if (!file) return; handleImageFile(file, indexPregunta); }
    async function quitarImagen(indexPregunta) { if (await mostrarConfirmacion("驴Est谩 seguro de eliminar la imagen?")) { cuestionarioData.preguntas[indexPregunta].adjunto = null; onAnyChange(); renderQuestionsUI(false); } }
    async function agregarOpcion(indexPregunta) {
        if (MODO_VISUALIZACION) return;
        const opts = cuestionarioData.preguntas[indexPregunta].opciones;
        if (opts.length >= 6) return await mostrarAlerta("L铆mite de 6 opciones por pregunta alcanzado.");
        // No incluir id_opcion para opciones nuevas (el servidor lo generar谩)
        opts.push({ opcion: `Nueva Opci贸n ${opts.length + 1}`, es_correcta_bool: opts.length === 0, descripcion: null, adjunto: null });
        onAnyChange(); renderQuestionsUI(false);
    }
    function actualizarOpcion(indexPregunta, indexOpcion, campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData.preguntas[indexPregunta].opciones[indexOpcion][campo] = valor; onAnyChange(); } }
    async function eliminarOpcion(indexPregunta, indexOpcion) {
        if (MODO_VISUALIZACION) return;
        if (await mostrarConfirmacion("驴Seguro que desea quitar esta opci贸n?")) {
            cuestionarioData.preguntas[indexPregunta].opciones.splice(indexOpcion, 1);
            onAnyChange(); renderQuestionsUI(false);
        }
    }
    function marcarOpcionCorrecta(indexPregunta, indexOpcionCorrecta) {
        if (MODO_VISUALIZACION) return;
        cuestionarioData.preguntas[indexPregunta].opciones.forEach((o, idx) => { o.es_correcta_bool = (idx === indexOpcionCorrecta); });
        onAnyChange(); renderQuestionsUI(false);
    }

    function validarDatos() {
        if (!cuestionarioData.titulo?.trim()) return "El t铆tulo del cuestionario no puede estar vac铆o.";
        for (let i = 0; i < cuestionarioData.preguntas.length; i++) {
            const p = cuestionarioData.preguntas[i];
            if (!p.pregunta?.trim()) return `El texto de la pregunta #${i + 1} no puede estar vac铆o.`;
            if (p.opciones.length < 2) return `La pregunta #${i + 1} debe tener al menos dos opciones.`;
            if (!p.opciones.some(o => o.es_correcta_bool)) return `La pregunta #${i + 1} debe tener una opci贸n marcada como correcta.`;
            for (let j = 0; j < p.opciones.length; j++) { if (!p.opciones[j].opcion?.trim()) return `El texto de la opci贸n #${j + 1} en la pregunta #${i + 1} no puede estar vac铆o.`; }
        }
        return true;
    }

    async function guardarTodo() {
        if (MODO_VISUALIZACION) { await mostrarAlerta("No puedes guardar cambios en modo visualizaci贸n."); return; }
        const valid = validarDatos(); if (valid !== true) { await mostrarAlerta(valid); return; }
        if (!hayCambios()) { await mostrarAlerta("No hay cambios para guardar."); return; }
        if (!(await mostrarConfirmacion("驴Seguro que desea guardar los cambios?"))) return;
        const cleanedData = JSON.parse(JSON.stringify(cuestionarioData));
        cleanedData.preguntas.forEach(p => { if (!p.adjunto) return; if (p.adjunto.startsWith('/static/uploads/')) p.adjunto = p.adjunto.replace('/static/uploads/', ''); else if (p.adjunto.startsWith('/static/')) p.adjunto = p.adjunto.replace('/static/', ''); });
        try {
            const response = await fetch('/api/cuestionarios/guardar-completo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cleanedData) });
            const resultado = await response.json();
            if (response.ok) {
                await mostrarAlerta('隆Cuestionario guardado con 茅xito!');
                window.removeEventListener('beforeunload', beforeUnloadHandler);
                // Recargar la p谩gina para obtener datos frescos con IDs actualizados
                if (CUESTIONARIO_ID) {
                    window.location.href = `/cuestionarios/${CUESTIONARIO_ID}/editar`;
                } else {
                    // Si es nuevo, redirigir al ID devuelto por el servidor
                    window.location.href = `/cuestionarios/${resultado.id_cuestionario}/editar`;
                }
            } else {
                await mostrarAlerta(`Error al guardar: ${resultado.error || 'Error desconocido'}`);
            }
        } catch (e) {
            await mostrarAlerta('Error de conexi贸n. No se pudo contactar al servidor.');
        }
    }

    async function cancelarTodo() {
        if (MODO_VISUALIZACION) { window.location.href = '/cuestionarios'; return; }
        if (hayCambios()) {
            const ok = await mostrarConfirmacion("驴Seguro que desea cancelar? Perder谩 los cambios no guardados.");
            if (!ok) return;
        }
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        window.location.href = `/cuestionarios`;
    }
    const beforeUnloadHandler = e => { if (!MODO_VISUALIZACION && hayCambios()) { e.preventDefault(); e.returnValue = ''; } };
    if (!MODO_VISUALIZACION) { window.addEventListener('beforeunload', beforeUnloadHandler); }

    function updateCharCounter(inputEl, counterId) {
        const el = document.getElementById(counterId); if (!el) return;
        const max = parseInt(inputEl.getAttribute('maxlength'), 10); const len = inputEl.value.length;
        el.textContent = `${len} / ${max}`; el.classList.remove('warning', 'limit');
        if (len >= max) el.classList.add('limit'); else if (len >= max * 0.9) el.classList.add('warning');
    }
    function crearPopup(message, buttons) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.style.display = 'flex'; // Asegurar que se muestre

            const box = document.createElement('div');
            box.className = 'popup-box';

            const p = document.createElement('p');
            p.style.whiteSpace = 'pre-wrap'; // Respetar saltos de l铆nea
            p.textContent = message;

            const btns = document.createElement('div');
            btns.className = 'popup-buttons';

            const closePopup = (result) => {
                if (overlay.parentNode) {
                    document.body.removeChild(overlay);
                }
                document.removeEventListener('keydown', handlePopupKey);
                resolve(result);
            };

            buttons.forEach((b, index) => {
                const bt = document.createElement('button');
                bt.textContent = b.text;
                bt.className = b.className;
                bt.dataset.result = b.resolvesTo;
                bt.onclick = () => closePopup(b.resolvesTo);
                if (index === buttons.length - 1) {
                    bt.focus(); // Auto-focus en 煤ltimo bot贸n (normalmente "Aceptar")
                }
                btns.appendChild(bt);
            });

            // Manejador de teclado para el popup
            const handlePopupKey = (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    // Escape = Cancelar (primer bot贸n) o cerrar
                    closePopup(buttons[0].resolvesTo);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // Enter = Aceptar (煤ltimo bot贸n)
                    closePopup(buttons[buttons.length - 1].resolvesTo);
                }
            };

            document.addEventListener('keydown', handlePopupKey);

            box.appendChild(p);
            box.appendChild(btns);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        });
    }
    function mostrarConfirmacion(msg) { return crearPopup(msg, [{ text: 'Cancelar', className: 'btn btn-secondary', resolvesTo: false }, { text: 'Aceptar', className: 'btn btn-success', resolvesTo: true }]); }
    function mostrarAlerta(msg) { return crearPopup(msg, [{ text: 'Aceptar', className: 'btn btn-primary', resolvesTo: true }]); }

    //  Funci贸n helper para mostrar tooltips de atajos de teclado
    function mostrarTooltipAtajo(mensaje) {
        const tooltip = document.createElement('div');
        tooltip.className = 'keyboard-tooltip';
        tooltip.textContent = mensaje;
        document.body.appendChild(tooltip);

        // Remover despu茅s de la animaci贸n (2s)
        setTimeout(() => {
            if (tooltip.parentNode) {
                document.body.removeChild(tooltip);
            }
        }, 2000);
    }

    //  SISTEMA CENTRALIZADO DE ATAJOS DE TECLADO
    const keyboardShortcuts = {
        // Atajos de acciones principales
        save: {
            keys: ['Ctrl+S', 'Meta+S'],
            description: 'Guardar cambios',
            action: () => {
                const btnSave = document.getElementById('btn-save');
                if (btnSave && !btnSave.disabled && !MODO_VISUALIZACION) {
                    btnSave.classList.add('btn-save-pulse');
                    setTimeout(() => btnSave.classList.remove('btn-save-pulse'), 300);
                    guardarTodo();
                    return true;
                } else if (MODO_VISUALIZACION) {
                    mostrarTooltipAtajo('锔 No puedes guardar en modo visualizaci贸n');
                } else {
                    mostrarTooltipAtajo('癸 No hay cambios para guardar');
                }
                return false;
            }
        },
        cancel: {
            keys: ['Ctrl+Z', 'Meta+Z'],
            description: 'Deshacer cambios',
            action: () => {
                const btnCancel = document.getElementById('btn-cancel');
                if (btnCancel && !btnCancel.disabled && !MODO_VISUALIZACION) {
                    cancelarTodo();
                    return true;
                } else if (MODO_VISUALIZACION) {
                    mostrarTooltipAtajo('锔 No puedes cancelar en modo visualizaci贸n');
                } else {
                    mostrarTooltipAtajo('癸 No hay cambios para cancelar');
                }
                return false;
            }
        },
        newQuestion: {
            keys: ['Ctrl+Q', 'Meta+Q'],
            description: 'Nueva pregunta',
            action: () => {
                if (MODO_VISUALIZACION) {
                    mostrarTooltipAtajo('锔 No puedes crear preguntas en modo visualizaci贸n');
                    return false;
                }
                agregarPregunta();
                mostrarTooltipAtajo(' Nueva pregunta creada');
                return true;
            }
        },
        deleteQuestion: {
            keys: ['Delete'],
            description: 'Eliminar pregunta actual',
            action: () => {
                if (currentView !== 'preguntas') {
                    mostrarTooltipAtajo('癸 Debes estar en vista de preguntas');
                    return false;
                }
                if (MODO_VISUALIZACION) {
                    mostrarTooltipAtajo('锔 No puedes eliminar en modo visualizaci贸n');
                    return false;
                }
                if (cuestionarioData.preguntas.length === 0) {
                    mostrarTooltipAtajo('锔 No hay preguntas para eliminar');
                    return false;
                }
                if (navigationMode === 'options') {
                    mostrarTooltipAtajo('锔 Sal del modo opciones primero (Escape)');
                    return false;
                }

                // Llamar a eliminarPregunta con confirmaci贸n
                eliminarPregunta(currentIndex);
                return true;
            }
        },
        // Navegaci贸n entre vistas
        viewGeneral: {
            keys: ['Alt+1'],
            description: 'Vista General',
            action: () => {
                switchView('general');
                mostrarTooltipAtajo(' Vista General');
                return true;
            }
        },
        viewPreguntas: {
            keys: ['Alt+2'],
            description: 'Vista Preguntas',
            action: () => {
                switchView('preguntas');
                mostrarTooltipAtajo(' Vista Preguntas');
                return true;
            }
        },
        // Navegaci贸n simple con Alt+Flechas
        nextQuestion: {
            keys: ['Alt+ArrowDown'],
            description: 'Siguiente pregunta',
            action: () => {
                if (currentView !== 'preguntas') {
                    mostrarTooltipAtajo('癸 Debes estar en vista de preguntas');
                    return false;
                }
                if (cuestionarioData.preguntas.length === 0) {
                    return false;
                }

                currentIndex = (currentIndex + 1) % cuestionarioData.preguntas.length;
                renderQuestionsUI(true);
                mostrarTooltipAtajo(` Pregunta ${currentIndex + 1} de ${cuestionarioData.preguntas.length}`);
                return true;
            }
        },
        prevQuestion: {
            keys: ['Alt+ArrowUp'],
            description: 'Pregunta anterior',
            action: () => {
                if (currentView !== 'preguntas') {
                    mostrarTooltipAtajo('癸 Debes estar en vista de preguntas');
                    return false;
                }
                if (cuestionarioData.preguntas.length === 0) {
                    return false;
                }

                currentIndex = currentIndex - 1;
                if (currentIndex < 0) {
                    currentIndex = cuestionarioData.preguntas.length - 1;
                }
                renderQuestionsUI(true);
                mostrarTooltipAtajo(` Pregunta ${currentIndex + 1} de ${cuestionarioData.preguntas.length}`);
                return true;
            }
        },
        closeModal: {
            keys: ['Escape'],
            description: 'Cerrar modal',
            action: () => {
                // Cerrar modal de importaci贸n si est谩 abierto
                const modalOverlay = document.getElementById('modal-importar-overlay');
                if (modalOverlay && modalOverlay.style.display !== 'none') {
                    cerrarModalImportar();
                    return true;
                }
                return false;
            }
        },
        importQuestions: {
            keys: ['Ctrl+I', 'Meta+I'],
            description: 'Importar preguntas desde Excel',
            action: () => {
                if (MODO_VISUALIZACION) {
                    mostrarTooltipAtajo('锔 No puedes importar en modo visualizaci贸n');
                    return false;
                }
                if (!CUESTIONARIO_ID) {
                    mostrarTooltipAtajo('锔 Guarda el cuestionario primero');
                    return false;
                }
                abrirModalImportar();
                mostrarTooltipAtajo(' Modal de importaci贸n abierto');
                return true;
            }
        },
        // Utilidades
        help: {
            keys: ['F1', '?'],
            description: 'Mostrar ayuda de atajos',
            action: () => {
                mostrarAyudaAtajos();
                return true;
            }
        }
    };

    //  Funci贸n para mostrar ayuda de atajos
    function mostrarAyudaAtajos() {
        let helpText = '锔 ATAJOS DE TECLADO DISPONIBLES\n\n';

        const categorias = {
            ' ACCIONES': ['save', 'cancel', 'newQuestion', 'deleteQuestion', 'importQuestions'],
            'Л NAVEGACIN': ['viewGeneral', 'viewPreguntas', 'nextQuestion', 'prevQuestion'],
            ' UTILIDADES': ['closeModal', 'help']
        };

        for (const [categoria, shortcuts] of Object.entries(categorias)) {
            helpText += ` ${categoria} \n`;
            shortcuts.forEach(key => {
                const shortcut = keyboardShortcuts[key];
                if (shortcut) {
                    const keysStr = shortcut.keys.join(' / ');
                    helpText += `  ${keysStr.padEnd(30)}  ${shortcut.description}\n`;
                }
            });
            helpText += '\n';
        }

        helpText += ' TIP: En popups usa Enter para aceptar, Escape para cancelar';

        // Usar el sistema de popup mejorado
        mostrarAlerta(helpText);
    }

    //  Manejador global de atajos de teclado
    function handleKeyboardShortcut(e) {
        // No procesar atajos si estamos escribiendo en un input/textarea
        const activeElement = document.activeElement;
        const isTyping = activeElement && (
            activeElement.tagName === 'INPUT' ||
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.isContentEditable
        );

        // Permitir solo algunos atajos mientras se escribe
        const allowedWhileTyping = ['save', 'cancel', 'closeModal', 'help', 'importQuestions'];

        for (const [key, shortcut] of Object.entries(keyboardShortcuts)) {
            // Verificar si el atajo coincide con la tecla presionada
            const matches = shortcut.keys.some(keyCombo => {
                const parts = keyCombo.split('+');

                // Casos especiales sin modificadores
                if (keyCombo === 'Escape') return e.key === 'Escape';
                if (keyCombo === '?') return e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey;
                if (keyCombo === 'F1') return e.key === 'F1';
                if (keyCombo === 'Delete') return e.key === 'Delete' && !e.ctrlKey && !e.metaKey && !e.altKey;

                // Atajos con modificadores
                const needsCtrl = parts.includes('Ctrl');
                const needsMeta = parts.includes('Meta');
                const needsAlt = parts.includes('Alt');
                const mainKey = parts[parts.length - 1];

                // Para teclas de flecha, comparar directamente con e.key
                if (mainKey.startsWith('Arrow')) {
                    return (
                        e.key === mainKey &&
                        (!needsCtrl || e.ctrlKey) &&
                        (!needsMeta || e.metaKey) &&
                        (!needsAlt || e.altKey)
                    );
                }

                // Para otras teclas, comparar en min煤sculas
                return (
                    e.key.toLowerCase() === mainKey.toLowerCase() &&
                    (!needsCtrl || e.ctrlKey) &&
                    (!needsMeta || e.metaKey) &&
                    (!needsAlt || e.altKey)
                );
            });

            if (matches) {
                // Si estamos escribiendo, solo permitir ciertos atajos
                if (isTyping && !allowedWhileTyping.includes(key)) {
                    continue;
                }

                e.preventDefault();
                const success = shortcut.action();

                if (success) {
                    console.log(`锔 Atajo ejecutado: ${shortcut.keys[0]} (${shortcut.description})`);
                }
                break;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        originalCuestionarioData = JSON.parse(JSON.stringify(cuestionarioData));
        const descTextarea = document.getElementById('descripcion');
        descTextarea.addEventListener('input', () => updateCharCounter(descTextarea, 'descripcion-char-counter'));
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('inPuntos') || e.target.classList.contains('inTiempo')) {
                const input = e.target, min = parseInt(input.min, 10) || 1, max = parseInt(input.max, 10) || 1000;
                let valor = parseInt(input.value, 10); if (isNaN(valor)) return;
                if (valor < min) input.value = min; else if (valor > max) input.value = max;
            }
        });
        document.getElementById('tab-general').addEventListener('click', () => switchView('general'));
        document.getElementById('tab-preguntas').addEventListener('click', () => switchView('preguntas'));
        const btnVolver = document.getElementById('btn-volver-general'); if (btnVolver) btnVolver.addEventListener('click', () => switchView('general'));
        const sw = document.getElementById('qSwitch');
        if (sw) { sw.addEventListener('click', e => { const b = e.target.closest('.sw'); if (!b) return; sw.querySelectorAll('.sw').forEach(x => x.classList.remove('active')); b.classList.add('active'); const mode = b.dataset.target; const lay = document.getElementById('qlayout'); lay.classList.toggle('show-sidebar', mode === 'sidebar'); lay.classList.toggle('show-editor', mode === 'editor'); }); }
        renderGeneral();
        updateActionButtons();
        updateResponsiveMode();
        window.addEventListener('resize', updateResponsiveMode);

        //  ACTIVAR MANEJADOR GLOBAL DE ATAJOS DE TECLADO
        document.addEventListener('keydown', handleKeyboardShortcut);

        // TEST EXCEL EN DOMContentLoaded
        const btnAbrirModal = document.getElementById('btn-abrir-modal-importar');
        const modalOverlay = document.getElementById('modal-importar-overlay'); // Declara la variable de nuevo para este scope
        const btnCancelarModal = document.getElementById('btn-cancelar-modal');
        const formImportar = document.getElementById('form-importar-preguntas');

        if (formImportar) {
            formImportar.addEventListener('submit', subirImportacion);
        }

        if (btnAbrirModal) btnAbrirModal.addEventListener('click', abrirModalImportar);

        if (btnCancelarModal) btnCancelarModal.addEventListener('click', cerrarModalImportar);

        if (modalOverlay) modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                cerrarModalImportar();
            }
        });
    });
</script>
{% endblock %}