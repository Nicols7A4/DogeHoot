{% extends "layout.html" %}

{% block head %}
{{ super() }}
<style>
    html,
    body {
        height: 100%;
        overflow: hidden
    }

    :root {
        --vh: 100dvh
    }

    * {
        box-sizing: border-box
    }

    .editor-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        height: var(--vh);
        padding: 0 .75rem .75rem;
        gap: .75rem
    }

    .topbar-tabs {
        display: flex;
        gap: .5rem;
        border-bottom: 1px solid var(--border-soft);
        align-items: center;
        padding-top: .5rem
    }

    .tab-btn {
        padding: .5rem .9rem;
        border: 1px solid var(--border-soft);
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        background: #f8fbff;
        color: var(--text-color);
        font-weight: 600;
        cursor: pointer;
        font-size: .95rem
    }

    .tab-btn.active {
        background: var(--panel-bg);
        box-shadow: var(--panel-shadow)
    }

    .top-actions {
        margin-left: auto;
        display: flex;
        gap: .5rem
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: .6rem 1rem;
        font-size: .95rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all .2s ease-in-out
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--btn-hover-shadow)
    }

    .btn[disabled] {
        opacity: .55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none
    }

    .btn-success {
        background: var(--btn-success-bg);
        color: var(--btn-success-text)
    }

    .btn-success:hover {
        border-color: var(--btn-success-text)
    }

    .btn-secondary {
        background: var(--btn-expired-bg);
        color: var(--text-muted)
    }

    .btn-secondary:hover {
        border-color: var(--text-muted);
        background: #e9ecef
    }

    .btn-primary {
        background: var(--btn-inprogress-bg);
        color: var(--btn-inprogress-text)
    }

    .btn-primary:hover {
        border-color: var(--btn-inprogress-text)
    }

    .btn-outline {
        background: #fff;
        border: 1px solid var(--border-soft);
        color: var(--text-color)
    }

    .btn-sm {
        padding: .45rem .75rem;
        font-size: .9rem
    }

    .views-wrapper {
        flex: 1;
        min-height: 0;
        display: grid
    }

    .view {
        display: none;
        min-height: 0
    }

    .view.active {
        display: grid;
        grid-template-rows: 1fr;
        min-height: 0
    }

    .card {
        background: var(--panel-bg);
        border-radius: 16px;
        box-shadow: var(--panel-shadow);
        border: 1px solid var(--border-soft);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 0
    }

    .card-header {
        padding: .8rem 1rem;
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-color);
        border-bottom: 1px solid var(--border-soft);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem
    }

    .card-body {
        padding: .8rem 1rem;
        min-height: 0;
        display: grid;
        grid-template-rows: 1fr;
        overflow: hidden
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: .75rem
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: .5rem
    }

    .form-group {
        display: grid;
        gap: .35rem
    }

    .form-group label {
        font-weight: 700;
        color: var(--text-color);
        font-size: .95rem
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: .7rem .9rem;
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        background: #fdfdfd;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        transition: all .2s ease
    }

    .form-control:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .15);
        background: var(--panel-bg)
    }

    textarea.form-control {
        resize: vertical;
        min-height: 110px
    }

    .char-counter-container {
        display: flex;
        justify-content: flex-end;
        margin-top: .25rem
    }

    .char-counter {
        font-size: .85rem;
        font-weight: 500;
        color: var(--text-muted)
    }

    .char-counter.warning {
        color: var(--btn-pending-text)
    }

    .char-counter.limit {
        color: var(--btn-failed-text);
        font-weight: 700
    }

    .inline-grid-two {
        display: grid;
        grid-template-columns: 1fr;
        gap: .75rem;
        align-items: end
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: .5rem;
        font-weight: 700;
        color: var(--text-color)
    }

    .section-title {
        font-weight: 800;
        color: var(--text-color);
        font-size: 1.05rem
    }

    .q-mobile-switch {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .5rem;
        margin-bottom: .5rem
    }

    .q-mobile-switch .sw {
        border: 1px solid var(--border-soft);
        background: #fff;
        border-radius: 10px;
        padding: .55rem .75rem;
        font-weight: 700;
        text-align: center;
        cursor: pointer
    }

    .q-mobile-switch .sw.active {
        background: #f3f7ff;
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .1)
    }

    .q-layout {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
        gap: .75rem;
        height: 100%;
        min-height: 0
    }

    .q-layout.show-sidebar .q-sidebar {
        display: grid
    }

    .q-layout.show-sidebar .q-canvas {
        display: none
    }

    .q-layout.show-editor .q-sidebar {
        display: none
    }

    .q-layout.show-editor .q-canvas {
        display: block
    }

    .q-sidebar {
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: .5rem;
        padding-bottom: .5rem;
        border-right: 1px dashed var(--border-soft);
        display: grid;
        gap: .75rem;
        scrollbar-gutter: stable;
        min-height: 0;
        height: 100%
    }

    .slide-card {
        display: flex;
        flex-direction: column;
        gap: .5rem;
        padding: .6rem;
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        background: #fff;
        cursor: pointer;
        transition: box-shadow .2s ease, border-color .2s ease
    }

    .slide-card.active {
        border-color: var(--btn-inprogress-text);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, .08)
    }

    .slide-thumb16x9 {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 8px;
        background: #f5f7ff;
        border: 1px solid var(--border-soft);
        overflow: hidden;
        display: block
    }

    .slide-thumb16x9 img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block
    }

    .slide-title-full {
        font-weight: 800;
        color: var(--text-color);
        line-height: 1.35
    }

    .slide-row {
        display: flex;
        justify-content: flex-end
    }

    .iconbtn {
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: .35rem .6rem;
        cursor: pointer
    }

    .iconbtn:hover {
        background: #f6f8ff
    }

    .q-canvas {
        background: linear-gradient(180deg, #fafcff 0%, #ffffff 100%);
        border: 1px solid var(--border-soft);
        border-radius: 16px;
        padding: .75rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, .04);
        min-height: 0;
        height: 100%;
        overflow: auto;
        display: block
    }

    .q-header-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .6rem;
        align-items: center;
        margin-bottom: .6rem
    }

    .q-header-grid .mini {
        display: flex;
        gap: .4rem;
        align-items: center
    }

    .q-header-grid label {
        font-size: .85rem;
        color: var(--text-muted);
        font-weight: 700;
        margin: 0
    }

    .q-title {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text-color);
        justify-self: end
    }

    .question-box {
        border-radius: 14px;
        background: #fff;
        border: 1px solid var(--border-soft);
        padding: .8rem;
        margin-bottom: .8rem;
        display: grid;
        grid-template-rows: auto auto auto;
        row-gap: .7rem
    }

    .question-input {
        width: 100%;
        font-size: 1.05rem;
        font-weight: 700;
        padding: .55rem .8rem;
        border-radius: 12px;
        border: 1px dashed var(--border-soft);
        background: #fcfdff
    }

    .media-wrap {
        border-radius: 14px;
        border: 2px dashed #cfe3ff;
        background: #f7faff;
        padding: .7rem;
        position: relative;
        min-height: 130px;
        max-height: 220px;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .media-wrap.dragover {
        border-color: #1E88E5;
        background: #eef6ff
    }

    .media-empty {
        text-align: center;
        color: #5c7fb1;
        font-size: .95rem
    }

    .media-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e8eef9
    }

    .media-controls {
        position: absolute;
        right: .6rem;
        bottom: .6rem;
        display: flex;
        gap: .5rem
    }

    .answer-grid {
        margin-top: .2rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: .6rem
    }

    .answer-card {
        border-radius: 12px;
        border: 2px solid transparent;
        background: #fff;
        padding: .65rem .8rem;
        min-height: 80px;
        display: grid;
        grid-template-columns: 28px 1fr;
        grid-template-rows: auto auto;
        grid-template-areas: "shape input" "tools counter";
        column-gap: .55rem;
        row-gap: .45rem;
        align-items: center;
        transition: box-shadow .2s ease, border-color .2s ease
    }

    .answer-card.correct {
        border-color: var(--btn-success-text);
        box-shadow: 0 0 0 3px rgba(23, 170, 118, .12)
    }

    .answer-shape {
        grid-area: shape;
        width: 26px;
        height: 26px;
        border-radius: 6px;
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900
    }

    .answer-content {
        grid-area: input;
        display: flex;
        flex-direction: column;
        gap: .25rem
    }

    .answer-input {
        width: 100%;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        padding: .55rem .7rem;
        background: #fff;
        outline: none;
        font-size: .95rem
    }

    .answer-input::placeholder {
        color: #9aa7b5
    }

    .answer-tools {
        grid-area: tools;
        display: flex;
        gap: .4rem;
        align-items: center
    }

    .answer-tools .btn-tool {
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: .35rem .6rem;
        cursor: pointer
    }

    .answer-tools .btn-tool:hover {
        background: #f3f6ff
    }

    .counter-small {
        grid-area: counter;
        font-size: .8rem;
        color: var(--text-muted);
        font-weight: 600;
        text-align: right
    }

    .variant-red {
        background: #ffe9ea;
        border-color: #ffccd0
    }

    .variant-red .answer-shape {
        background: #E53935
    }

    .variant-blue {
        background: #eaf2ff;
        border-color: #cfe0ff
    }

    .variant-blue .answer-shape {
        background: #1E88E5
    }

    .variant-yellow {
        background: #fff7e2;
        border-color: #ffe7ab
    }

    .variant-yellow .answer-shape {
        background: #F9A825
    }

    .variant-green {
        background: #e6f6ef;
        border-color: #bfe9d8
    }

    .variant-green .answer-shape {
        background: #2E7D32
    }

    .add-more-zone {
        display: flex;
        justify-content: center;
        margin-top: .45rem
    }

    .add-more-btn {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        padding: .55rem 1rem;
        border-radius: 999px;
        border: 1px dashed var(--border-soft);
        background: #f7fbff;
        cursor: pointer;
        font-weight: 700
    }

    .modo-visualizacion .form-control,
    .modo-visualizacion .form-select {
        background: #f5f5f5;
        border-color: #e0e0e0;
        color: #616161;
        cursor: not-allowed;
        pointer-events: none
    }

    .modo-visualizacion .card-header button {
        display: none !important
    }

    .popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px)
    }

    .popup-box {
        background: var(--panel-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, .2);
        text-align: center;
        width: 90%;
        max-width: 420px;
        border: 1px solid var(--border-soft)
    }

    .popup-box p {
        margin: 0 0 16px;
        font-size: 1.02rem;
        color: var(--text-color);
        line-height: 1.6
    }

    .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 12px
    }

    @media (min-width:768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
            gap: 1rem
        }

        .inline-grid-two {
            grid-template-columns: 1fr auto
        }

        .q-header-grid {
            grid-template-columns: repeat(2, 1fr) 2fr
        }

        .answer-grid {
            grid-template-columns: 1fr 1fr
        }
    }

    @media (min-width:1024px) {
        .editor-container {
            padding: 0 1rem 1rem
        }

        .tab-btn {
            padding: .6rem 1rem
        }

        .card-header {
            padding: 1rem 1.25rem
        }

        .card-body {
            padding: 1rem 1.25rem
        }

        .form-grid {
            grid-template-columns: 1fr 1fr
        }

        .view.active {
            grid-template-rows: 1fr
        }

        .q-mobile-switch {
            display: none
        }

        .q-layout {
            grid-template-columns: 340px 1fr;
            grid-template-rows: 1fr;
            gap: 1rem
        }

        .q-layout .q-sidebar {
            display: grid
        }

        .q-layout .q-canvas {
            display: block
        }

        .q-layout.show-sidebar .q-canvas {
            display: block
        }

        .q-layout.show-editor .q-sidebar {
            display: grid
        }

        .answer-grid {
            grid-template-columns: 1fr 1fr
        }

        .question-input {
            font-size: 1.1rem
        }

        .q-title {
            font-size: 1.1rem
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container {% if modo_visualizacion %}modo-visualizacion{% endif %}">
    <div class="topbar-tabs">
        <button id="tab-general" class="tab-btn active" type="button">Datos generales</button>
        <button id="tab-preguntas" class="tab-btn" type="button">Preguntas y respuestas</button>
        <div class="top-actions">
            {% if not modo_visualizacion %}
            <button id="btn-save" class="btn btn-success" onclick="guardarTodo()" disabled>Guardar cambios</button>
            <button id="btn-cancel" class="btn btn-secondary" onclick="cancelarTodo()" disabled>Cancelar</button>
            {% else %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Ir al Dashboard</a>
            {% endif %}
        </div>
    </div>

    <div class="views-wrapper">
        <div id="view-general" class="view active">
            <div class="card">
                <div class="card-header"><span id="titulo-pagina" class="section-title"></span></div>
                <div class="card-body" style="overflow:auto;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="titulo">Título</label>
                            <input type="text" id="titulo" class="form-control" placeholder="Título del cuestionario"
                                oninput="actualizarDato('titulo', this.value)" maxlength="100" {% if modo_visualizacion
                                %}readonly{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="id_categoria">Categoría</label>
                            <select id="id_categoria" class="form-select"
                                onchange="actualizarDato('id_categoria', parseInt(this.value, 10))" {% if
                                modo_visualizacion %}disabled{% endif %}>
                                {% for cat in categorias %}
                                <option value="{{ cat.id_categoria }}">{{ cat.categoria }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="grid-column:1/-1">
                            <label for="descripcion">Descripción</label>
                            <textarea id="descripcion" class="form-control" placeholder="Objetivo del cuestionario"
                                oninput="actualizarDato('descripcion', this.value)" maxlength="500" {% if
                                modo_visualizacion %}readonly{% endif %}></textarea>
                            <div class="char-counter-container"><span id="descripcion-char-counter"
                                    class="char-counter">0 / 500</span></div>
                        </div>
                        <div class="form-row" style="grid-column:1/-1;align-items:center">
                            <label class="form-check">
                                <input type="checkbox" id="es_publico"
                                    onchange="actualizarDato('es_publico', this.checked)" {% if modo_visualizacion
                                    %}disabled{% endif %}>
                                ¿Hacer público?
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-preguntas" class="view">
            <div class="card">
                <div class="card-header">
                    <span>Editor de preguntas</span>
                    {% if not modo_visualizacion %}
                    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                        <button class="btn btn-outline btn-sm" id="btn-volver-general" type="button">Volver a datos
                            generales</button>
                        <button class="btn btn-primary btn-sm" onclick="agregarPregunta()">Añadir pregunta</button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="q-mobile-switch" id="qSwitch">
                        <div class="sw active" data-target="sidebar">Lista</div>
                        <div class="sw" data-target="editor">Editor</div>
                    </div>
                    <div class="q-layout show-sidebar" id="qlayout">
                        <aside class="q-sidebar" id="slides-sidebar"></aside>
                        <section class="q-canvas">
                            <div id="canvas-contenido"></div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="boot-data" type="application/json">
{
    "CUESTIONARIO_ID": {{ (cuestionario_data.id_cuestionario if cuestionario_data else none) | tojson }},
    "MODO_VISUALIZACION": {{ (modo_visualizacion | default(false)) | tojson }},
    "DATOS_DESDE_SERVIDOR": {{ (cuestionario_data if cuestionario_data else none) | tojson }},
    "SESSION_USER_ID": {{ (session.user_id | default(none)) | tojson }}
}
</script>

<script>
    const __BOOT = JSON.parse(document.getElementById('boot-data')?.textContent || '{}');
    const CUESTIONARIO_ID = __BOOT.CUESTIONARIO_ID ?? null;
    const MODO_VISUALIZACION = !!__BOOT.MODO_VISUALIZACION;

    let cuestionarioData = { id_cuestionario: null, titulo: 'Nuevo Cuestionario', descripcion: '', id_categoria: 1, es_publico: false, id_usuario: __BOOT.SESSION_USER_ID, preguntas: [] };
    let originalCuestionarioData;
    let currentView = 'general';
    let currentIndex = 0;

    const datosDesdeServidor = __BOOT.DATOS_DESDE_SERVIDOR;
    if (datosDesdeServidor) { cuestionarioData = datosDesdeServidor; }

    function resolveAdjuntoSrc(adjunto) {
        if (!adjunto) return null;
        if (adjunto.startsWith('data:image')) return adjunto;
        if (adjunto.startsWith('http')) return encodeURI(adjunto);
        if (adjunto.startsWith('/static/')) return encodeURI(adjunto);
        if (adjunto.startsWith('img/')) return encodeURI('/static/' + adjunto);
        if (adjunto.startsWith('uploads/')) return encodeURI('/static/' + adjunto);
        if (!adjunto.includes('/')) {
            if (typeof CUESTIONARIO_ID === 'number' || (typeof CUESTIONARIO_ID === 'string' && CUESTIONARIO_ID)) {
                return encodeURI(`/static/img/cuestionarios/c_${CUESTIONARIO_ID}/${adjunto}`);
            }
            return encodeURI('/static/' + adjunto);
        }
        return encodeURI('/static/' + adjunto);
    }

    function updateResponsiveMode() {
        const isDesktop = window.matchMedia('(min-width:1024px)').matches;
        const lay = document.getElementById('qlayout');
        const switcher = document.getElementById('qSwitch');
        if (!lay) return;
        if (isDesktop) {
            lay.classList.remove('show-sidebar', 'show-editor');
            if (switcher) switcher.style.display = 'none';
        } else {
            if (!lay.classList.contains('show-sidebar') && !lay.classList.contains('show-editor')) lay.classList.add('show-sidebar');
            if (switcher) switcher.style.display = 'grid';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        originalCuestionarioData = JSON.parse(JSON.stringify(cuestionarioData));
        const descTextarea = document.getElementById('descripcion');
        descTextarea.addEventListener('input', () => updateCharCounter(descTextarea, 'descripcion-char-counter'));
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('inPuntos') || e.target.classList.contains('inTiempo')) {
                const input = e.target, min = parseInt(input.min, 10) || 1, max = parseInt(input.max, 10) || 1000;
                let valor = parseInt(input.value, 10); if (isNaN(valor)) return;
                if (valor < min) input.value = min; else if (valor > max) input.value = max;
            }
        });
        document.getElementById('tab-general').addEventListener('click', () => switchView('general'));
        document.getElementById('tab-preguntas').addEventListener('click', () => switchView('preguntas'));
        const btnVolver = document.getElementById('btn-volver-general'); if (btnVolver) btnVolver.addEventListener('click', () => switchView('general'));
        const sw = document.getElementById('qSwitch');
        if (sw) { sw.addEventListener('click', e => { const b = e.target.closest('.sw'); if (!b) return; sw.querySelectorAll('.sw').forEach(x => x.classList.remove('active')); b.classList.add('active'); const mode = b.dataset.target; const lay = document.getElementById('qlayout'); lay.classList.toggle('show-sidebar', mode === 'sidebar'); lay.classList.toggle('show-editor', mode === 'editor'); }); }
        renderGeneral();
        updateActionButtons();
        updateResponsiveMode();
        window.addEventListener('resize', updateResponsiveMode);
    });

    function hayCambios() { return JSON.stringify(cuestionarioData) !== JSON.stringify(originalCuestionarioData); }
    function onAnyChange() { updateActionButtons(); }
    function updateActionButtons() { const save = document.getElementById('btn-save'); const cancel = document.getElementById('btn-cancel'); if (!save || !cancel) return; const changed = hayCambios(); save.disabled = !changed; cancel.disabled = !changed; }

    function switchView(view) {
        currentView = view;
        document.getElementById('tab-general').classList.toggle('active', view === 'general');
        document.getElementById('tab-preguntas').classList.toggle('active', view === 'preguntas');
        document.getElementById('view-general').classList.toggle('active', view === 'general');
        document.getElementById('view-preguntas').classList.toggle('active', view === 'preguntas');
        if (view === 'general') renderGeneral(); else renderQuestionsUI(true);
    }

    function renderGeneral() {
        document.getElementById('titulo-pagina').textContent = cuestionarioData.titulo || 'Nuevo Cuestionario';
        document.getElementById('titulo').value = cuestionarioData.titulo;
        document.getElementById('descripcion').value = cuestionarioData.descripcion;
        document.getElementById('id_categoria').value = cuestionarioData.id_categoria;
        document.getElementById('es_publico').checked = cuestionarioData.es_publico;
        document.getElementById('descripcion').dispatchEvent(new Event('input'));
        updateActionButtons();
    }

    function renderQuestionsUI(scrollCanvasTop = false) {
        const sidebar = document.getElementById('slides-sidebar');
        const canvas = document.getElementById('canvas-contenido');
        sidebar.innerHTML = ''; canvas.innerHTML = '';
        cuestionarioData.preguntas.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'slide-card' + (i === currentIndex ? ' active' : '');
            card.onclick = () => { currentIndex = i; renderQuestionsUI(true); };
            const src = resolveAdjuntoSrc(p.adjunto);
            if (src) {
                const thumb = document.createElement('div'); thumb.className = 'slide-thumb16x9';
                const img = document.createElement('img'); img.src = src; img.alt = 'Miniatura';
                thumb.appendChild(img); card.appendChild(thumb);
            }
            const title = document.createElement('div'); title.className = 'slide-title-full';
            const texto = (p.pregunta && !/^Nueva Pregunta/.test(p.pregunta)) ? p.pregunta.trim() : `Pregunta ${i + 1}`;
            title.textContent = texto; card.appendChild(title);
            if (!MODO_VISUALIZACION) {
                const row = document.createElement('div'); row.className = 'slide-row';
                const del = document.createElement('button'); del.className = 'iconbtn'; del.textContent = 'Eliminar';
                del.onclick = async (ev) => { ev.stopPropagation(); if (await mostrarConfirmacion("¿Seguro que desea quitar esta pregunta?")) { cuestionarioData.preguntas.splice(i, 1); if (currentIndex >= cuestionarioData.preguntas.length) currentIndex = Math.max(0, cuestionarioData.preguntas.length - 1); onAnyChange(); renderQuestionsUI(true); } };
                row.appendChild(del); card.appendChild(row);
            }
            sidebar.appendChild(card);
            if (i === currentIndex) { setTimeout(() => card.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' }), 0); }
        });
        if (!MODO_VISUALIZACION) {
            const add = document.createElement('button'); add.className = 'btn btn-primary btn-sm'; add.style.marginTop = '.25rem';
            add.textContent = 'Añadir pregunta'; add.onclick = agregarPregunta; sidebar.appendChild(add);
        }
        if (cuestionarioData.preguntas.length === 0) {
            const empty = document.createElement('div');
            empty.innerHTML = `<div style="display:grid;place-items:center;gap:.75rem;padding:2rem;border:1px dashed var(--border-soft);border-radius:12px;background:#fff;">
            <div class="q-title">Aún no hay preguntas</div>
            ${MODO_VISUALIZACION ? '' : '<button class="btn btn-primary" onclick="agregarPregunta()">Crear la primera pregunta</button>'}
        </div>`;
            canvas.appendChild(empty); return;
        }
        const p = cuestionarioData.preguntas[currentIndex];
        const readonly = MODO_VISUALIZACION ? 'readonly' : '';
        const VARIANTS = ['variant-red', 'variant-blue', 'variant-yellow', 'variant-green'];
        const SHAPES = ['▲', '◆', '●', '■'];
        const cleanValue = (txt) => (!txt || /^Nueva (Pregunta|Opción)/.test(txt)) ? '' : txt;
        const mediaSrc = resolveAdjuntoSrc(p.adjunto);
        const html = `
    <div class="q-header-grid">
      <div class="mini">
        <label for="puntaje-${currentIndex}">Puntos</label>
        <input type="number" id="puntaje-${currentIndex}" class="form-control inPuntos" placeholder="0" value="${p.puntaje_base ?? ''}" oninput="actualizarPregunta(${currentIndex},'puntaje_base',parseInt(this.value,10))" min="1" max="1000" ${readonly}>
      </div>
      <div class="mini">
        <label for="tiempo-${currentIndex}">Tiempo (s)</label>
        <input type="number" id="tiempo-${currentIndex}" class="form-control inTiempo" placeholder="0" value="${p.tiempo ?? ''}" oninput="actualizarPregunta(${currentIndex},'tiempo',parseInt(this.value,10))" min="10" max="100" ${readonly}>
      </div>
      <div class="q-title">Pregunta ${p.num_pregunta || (currentIndex + 1)}</div>
    </div>
    <div class="question-box">
      <div>
        <input type="text" class="question-input" placeholder="Escribe la pregunta aquí…" value="${cleanValue(p.pregunta)}" oninput="actualizarPregunta(${currentIndex},'pregunta',this.value); updateCharCounter(this,'pregunta-counter-${currentIndex}')" maxlength="150" ${readonly}>
        <div class="char-counter-container"><span id="pregunta-counter-${currentIndex}" class="char-counter">0 / 150</span></div>
      </div>
      <div class="media-wrap" id="dropzone-${currentIndex}">
        ${mediaSrc ? `
          <img id="media-img-${currentIndex}" class="media-image" src="${mediaSrc}" alt="Imagen de la pregunta">
          ${MODO_VISUALIZACION ? '' : `
            <div class="media-controls">
              <label class="btn btn-outline btn-sm">Cambiar
                <input type="file" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">
              </label>
              <button class="btn btn-secondary btn-sm" onclick="quitarImagen(${currentIndex})">Eliminar</button>
            </div>
          `}
        `: `
          <div class="media-empty">
            <div style="font-weight:700;margin-bottom:.3rem;">Buscar e insertar media</div>
            <label style="text-decoration:underline; cursor:pointer;">
              <input type="file" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">
              Subir archivo
            </label>
            <div>o arrastra y suelta aquí</div>
          </div>
          ${MODO_VISUALIZACION ? '' : `<input type="file" id="hidden-file-${currentIndex}" accept="image/*" style="display:none" onchange="convertirImagen(this,${currentIndex})">`}
        `}
      </div>
      <div class="answer-grid">
        ${p.opciones.map((op, idx) => {
            const v = VARIANTS[idx % 4], shape = SHAPES[idx % 4], correctClass = op.es_correcta_bool ? 'correct' : ''; return `
          <div class="answer-card ${v} ${correctClass}">
            <div class="answer-shape">${shape}</div>
            <div class="answer-content">
              <input type="text" class="answer-input" placeholder="Escribe una respuesta…" value="${cleanValue(op.opcion)}" oninput="actualizarOpcion(${currentIndex},${idx},'opcion',this.value); updateCharCounter(this,'opcion-counter-${currentIndex}-${idx}')" maxlength="100" ${readonly}>
            </div>
            <div class="answer-tools">
              ${MODO_VISUALIZACION ? '' : `
                <button class="btn-tool" title="Marcar como correcta" onclick="marcarOpcionCorrecta(${currentIndex},${idx})">Correcta</button>
                <button class="btn-tool" title="Eliminar opción" onclick="eliminarOpcion(${currentIndex},${idx})">Eliminar</button>
              `}
            </div>
            <div class="counter-small" id="opcion-counter-${currentIndex}-${idx}">0 / 100</div>
          </div>`;
        }).join('')}
      </div>
      ${MODO_VISUALIZACION ? '' : `
      <div class="add-more-zone">
        <button class="add-more-btn" onclick="agregarOpcion(${currentIndex})">Añadir más respuestas</button>
      </div>`}
    </div>`;
        canvas.innerHTML = html;
        canvas.querySelectorAll('input[maxlength]').forEach(el => el.dispatchEvent(new Event('input')));
        if (!MODO_VISUALIZACION) initDropzone(`dropzone-${currentIndex}`, currentIndex);
        if (scrollCanvasTop) { const target = document.querySelector('.slide-card.active'); if (target) target.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); }
        updateActionButtons();
    }

    function initDropzone(id, idx) {
        const z = document.getElementById(id); if (!z) return;
        ['dragenter', 'dragover'].forEach(evn => z.addEventListener(evn, e => { e.preventDefault(); e.stopPropagation(); z.classList.add('dragover'); }));
        ['dragleave', 'drop'].forEach(evn => z.addEventListener(evn, e => { e.preventDefault(); e.stopPropagation(); z.classList.remove('dragover'); }));
        z.addEventListener('drop', e => { const f = e.dataTransfer?.files?.[0]; if (f) handleImageFile(f, idx); });
    }
    function handleImageFile(file, indexPregunta) { const r = new FileReader(); r.onload = e => { cuestionarioData.preguntas[indexPregunta].adjunto = e.target.result; onAnyChange(); renderQuestionsUI(false); }; r.readAsDataURL(file); }

    function actualizarDato(campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData[campo] = valor; onAnyChange(); } }
    function agregarPregunta() {
        if (MODO_VISUALIZACION) return;
        const cant = cuestionarioData.preguntas.length;
        cuestionarioData.preguntas.push({ id_pregunta: 'temp_' + Date.now(), pregunta: `Nueva Pregunta ${cant + 1}`, num_pregunta: cant + 1, puntaje_base: 1000, tiempo: 15, opciones: [] });
        agregarOpcion(cuestionarioData.preguntas.length - 1);
        currentIndex = cuestionarioData.preguntas.length - 1;
        onAnyChange(); renderQuestionsUI(true);
    }
    function actualizarPregunta(index, campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData.preguntas[index][campo] = valor; onAnyChange(); } }
    async function eliminarPregunta(index) {
        if (MODO_VISUALIZACION) return;
        if (await mostrarConfirmacion("¿Seguro que desea quitar esta pregunta?")) {
            cuestionarioData.preguntas.splice(index, 1);
            if (currentIndex >= cuestionarioData.preguntas.length) currentIndex = Math.max(0, cuestionarioData.preguntas.length - 1);
            onAnyChange(); renderQuestionsUI(true);
        }
    }
    function convertirImagen(input, indexPregunta) { const file = input.files[0]; if (!file) return; handleImageFile(file, indexPregunta); }
    async function quitarImagen(indexPregunta) { if (await mostrarConfirmacion("¿Está seguro de eliminar la imagen?")) { cuestionarioData.preguntas[indexPregunta].adjunto = null; onAnyChange(); renderQuestionsUI(false); } }
    async function agregarOpcion(indexPregunta) {
        if (MODO_VISUALIZACION) return;
        const opts = cuestionarioData.preguntas[indexPregunta].opciones;
        if (opts.length >= 6) return await mostrarAlerta("Límite de 6 opciones por pregunta alcanzado.");
        opts.push({ id_opcion: 'temp_opt_' + Date.now(), opcion: `Nueva Opción ${opts.length + 1}`, es_correcta_bool: opts.length === 0 });
        onAnyChange(); renderQuestionsUI(false);
    }
    function actualizarOpcion(indexPregunta, indexOpcion, campo, valor) { if (!MODO_VISUALIZACION) { cuestionarioData.preguntas[indexPregunta].opciones[indexOpcion][campo] = valor; onAnyChange(); } }
    async function eliminarOpcion(indexPregunta, indexOpcion) {
        if (MODO_VISUALIZACION) return;
        if (await mostrarConfirmacion("¿Seguro que desea quitar esta opción?")) {
            cuestionarioData.preguntas[indexPregunta].opciones.splice(indexOpcion, 1);
            onAnyChange(); renderQuestionsUI(false);
        }
    }
    function marcarOpcionCorrecta(indexPregunta, indexOpcionCorrecta) {
        if (MODO_VISUALIZACION) return;
        cuestionarioData.preguntas[indexPregunta].opciones.forEach((o, idx) => { o.es_correcta_bool = (idx === indexOpcionCorrecta); });
        onAnyChange(); renderQuestionsUI(false);
    }

    function validarDatos() {
        if (!cuestionarioData.titulo?.trim()) return "El título del cuestionario no puede estar vacío.";
        for (let i = 0; i < cuestionarioData.preguntas.length; i++) {
            const p = cuestionarioData.preguntas[i];
            if (!p.pregunta?.trim()) return `El texto de la pregunta #${i + 1} no puede estar vacío.`;
            if (p.opciones.length < 2) return `La pregunta #${i + 1} debe tener al menos dos opciones.`;
            if (!p.opciones.some(o => o.es_correcta_bool)) return `La pregunta #${i + 1} debe tener una opción marcada como correcta.`;
            for (let j = 0; j < p.opciones.length; j++) { if (!p.opciones[j].opcion?.trim()) return `El texto de la opción #${j + 1} en la pregunta #${i + 1} no puede estar vacío.`; }
        }
        return true;
    }

    async function guardarTodo() {
        if (MODO_VISUALIZACION) { await mostrarAlerta("No puedes guardar cambios en modo visualización."); return; }
        const valid = validarDatos(); if (valid !== true) { await mostrarAlerta(valid); return; }
        if (!hayCambios()) { await mostrarAlerta("No hay cambios para guardar."); return; }
        if (!(await mostrarConfirmacion("¿Seguro que desea guardar los cambios?"))) return;
        const cleanedData = JSON.parse(JSON.stringify(cuestionarioData));
        cleanedData.preguntas.forEach(p => { if (!p.adjunto) return; if (p.adjunto.startsWith('/static/uploads/')) p.adjunto = p.adjunto.replace('/static/uploads/', ''); else if (p.adjunto.startsWith('/static/')) p.adjunto = p.adjunto.replace('/static/', ''); });
        try {
            const response = await fetch('/api/cuestionarios/guardar-completo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cleanedData) });
            const resultado = await response.json();
            if (response.ok) {
                originalCuestionarioData = JSON.parse(JSON.stringify(cuestionarioData));
                await mostrarAlerta('¡Cuestionario guardado con éxito!');
                updateActionButtons();
                window.removeEventListener('beforeunload', beforeUnloadHandler);
                window.location.href = '/cuestionarios';
            } else {
                await mostrarAlerta(`Error al guardar: ${resultado.error || 'Error desconocido'}`);
            }
        } catch (e) {
            await mostrarAlerta('Error de conexión. No se pudo contactar al servidor.');
        }
    }

    async function cancelarTodo() {
        if (MODO_VISUALIZACION) { window.location.href = '/cuestionarios'; return; }
        if (hayCambios()) {
            const ok = await mostrarConfirmacion("¿Seguro que desea cancelar? Perderá los cambios no guardados.");
            if (!ok) return;
        }
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        window.location.href = `/cuestionarios`;
    }
    const beforeUnloadHandler = e => { if (!MODO_VISUALIZACION && hayCambios()) { e.preventDefault(); e.returnValue = ''; } };
    if (!MODO_VISUALIZACION) { window.addEventListener('beforeunload', beforeUnloadHandler); }

    function updateCharCounter(inputEl, counterId) {
        const el = document.getElementById(counterId); if (!el) return;
        const max = parseInt(inputEl.getAttribute('maxlength'), 10); const len = inputEl.value.length;
        el.textContent = `${len} / ${max}`; el.classList.remove('warning', 'limit');
        if (len >= max) el.classList.add('limit'); else if (len >= max * 0.9) el.classList.add('warning');
    }
    function crearPopup(message, buttons) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div'); overlay.className = 'popup-overlay';
            const box = document.createElement('div'); box.className = 'popup-box';
            const p = document.createElement('p'); p.textContent = message;
            const btns = document.createElement('div'); btns.className = 'popup-buttons';
            buttons.forEach(b => { const bt = document.createElement('button'); bt.textContent = b.text; bt.className = b.className; bt.onclick = () => { document.body.removeChild(overlay); resolve(b.resolvesTo); }; btns.appendChild(bt); });
            box.appendChild(p); box.appendChild(btns); overlay.appendChild(box); document.body.appendChild(overlay);
        });
    }
    function mostrarConfirmacion(msg) { return crearPopup(msg, [{ text: 'Cancelar', className: 'btn btn-secondary', resolvesTo: false }, { text: 'Aceptar', className: 'btn btn-success', resolvesTo: true }]); }
    function mostrarAlerta(msg) { return crearPopup(msg, [{ text: 'Aceptar', className: 'btn btn-primary', resolvesTo: true }]); }
</script>
{% endblock %}