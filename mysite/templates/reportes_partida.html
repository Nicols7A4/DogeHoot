<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Partida</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        /* ===================== */
        /* Variables             */
        /* ===================== */
        :root {
            --btn-pending-bg: #FFECD1;
            --btn-pending-text: #F77F00;
            --btn-inprogress-bg: #E6F2FF;
            --btn-inprogress-text: #1E88E5;
            --btn-submitted-bg: #F1E8FF;
            --btn-submitted-text: #8E5CF6;
            --btn-success-bg: #E8F9E9;
            --btn-success-text: #2BB673;
            --btn-failed-bg: #FFE6E6;
            --btn-failed-text: #E53935;
            --btn-expired-bg: #F5F5F5;
            --btn-expired-text: #9E9E9E;
            --main-bg: #FFF9ED;
            --panel-bg: #FFFFFF;
            --border-soft: #E0E0E0;
            --text-color: #333333;
            --text-muted: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===================== */
        /* Layout Base           */
        /* ===================== */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--main-bg);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===================== */
        /* Header                */
        /* ===================== */
        .page-header {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-soft);
        }

        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        #header-info {
            background: var(--btn-inprogress-bg);
            border: 2px solid var(--btn-inprogress-text);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        #header-info p {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.6;
        }

        #header-info strong {
            color: var(--btn-inprogress-text);
        }

        /* ===================== */
        /* Loading               */
        /* ===================== */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--btn-inprogress-text);
        }

        /* ===================== */
        /* Buttons               */
        /* ===================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            border-radius: 8px;
            padding: 0.875rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15);
            position: relative;
            top: 0;
            font-family: 'Poppins', sans-serif;
            color: white;
            text-decoration: none;
        }

        .btn:hover:not(:disabled) {
            top: 2px;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) {
            top: 4px;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-back {
            background: var(--btn-expired-bg);
            color: var(--text-color);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        }

        .btn-excel {
            background: var(--btn-success-text);
        }

        .btn-onedrive {
            background: var(--btn-inprogress-text);
        }

        .btn-drive {
            background: var(--btn-failed-text);
        }

        /* ===================== */
        /* Modal                 */
        /* ===================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 999;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .modal-card {
            width: min(420px, 100%);
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
            border: 2px solid var(--border-soft);
        }

        .modal-card h3 {
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            color: var(--text-color);
        }

        .modal-card p {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 1.25rem;
        }

        .modal-card input[type="email"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .modal-error {
            font-size: 0.85rem;
            color: var(--btn-failed-text);
            min-height: 1.2rem;
            margin-bottom: 0.75rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .modal-actions button {
            padding: 0.7rem 1.4rem;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }

        .modal-actions .btn-secondary {
            background: var(--btn-expired-bg);
            color: var(--btn-expired-text);
        }

        .modal-actions .btn-primary {
            background: var(--btn-inprogress-text);
            color: #ffffff;
        }

        .modal-actions button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===================== */
        /* Sections              */
        /* ===================== */
        .section {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-soft);
        }

        .section h2 {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #resumen-global p {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.8;
        }

        /* ===================== */
        /* Tables                */
        /* ===================== */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }

        th,
        td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border-soft);
        }

        th {
            background: var(--btn-submitted-text);
            color: white;
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background: var(--btn-submitted-bg);
        }

        td {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Destacar primera fila (1er lugar) */
        tbody tr:first-child {
            background: linear-gradient(135deg, #FFE082, #FFD54F);
        }

        tbody tr:first-child:hover {
            background: linear-gradient(135deg, #FFD54F, #FFC107);
        }

        /* ===================== */
        /* Media Queries         */
        /* ===================== */

        /* Tablets (768px+) */
        @media (min-width: 768px) {
            body {
                padding: 2rem;
            }

            .page-header {
                padding: 2rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .header-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .btn {
                width: auto;
                min-width: 200px;
            }

            .section {
                padding: 2rem;
            }

            .section h2 {
                font-size: 1.5rem;
            }

            th,
            td {
                padding: 1rem;
            }

            th {
                font-size: 0.9rem;
            }

            td {
                font-size: 0.9rem;
            }
        }

        /* Desktop (1024px+) */
        @media (min-width: 1024px) {
            .page-header h1 {
                font-size: 2.25rem;
            }

            .section h2 {
                font-size: 1.75rem;
            }

            #header-info p,
            #resumen-global p {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>Reporte de Partida</h1>

            <div class="loading" id="loading">Cargando datos...</div>

            <div id="header-info"></div>

            <div class="header-actions">
                <!-- <button class="btn btn-back" onclick="window.history.back()">Volver</button> -->
                <button class="btn btn-back" onclick="irADashboard()">Volver</button>
                <button class="btn btn-excel" onclick="exportarExcel()">Descargar Excel</button>
                <button class="btn btn-onedrive" onclick="exportarOneDrive()">Exportar a OneDrive</button>
                <button class="btn btn-drive" onclick="exportarDrive()">Exportar a Drive</button>
            </div>
        </div>

        <div class="section">
            <h2>Resumen Global</h2>
            <div id="resumen-global"></div>
        </div>

        <div class="section">
            <h2>Ranking Final</h2>
            <div class="table-container">
                <table id="tabla-ranking">
                    <thead>
                        <tr>
                            <th>Posicion</th>
                            <th>Grupo</th>
                            <th>Usuario</th>
                            <th>Puntaje Total</th>
                            <th>Monedas</th>
                            <th>Correctas</th>
                            <th>Incorrectas</th>
                            <th>% Acierto</th>
                            <th>Tiempo Prom (s)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Detalle por Pregunta</h2>
            <div class="table-container">
                <table id="tabla-preguntas">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Pregunta</th>
                            <th>Opcion Correcta</th>
                            <th>% Acierto</th>
                            <th>Tiempo Prom (s)</th>
                            <th>Respuestas</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="email-modal-title" aria-hidden="true">
        <form class="modal-card">
            <h3 id="email-modal-title">Compartir reporte</h3>
            <p id="email-modal-message">Ingresa el correo con quien deseas compartir el reporte.</p>
            <div class="modal-error" id="email-modal-error"></div>
            <input type="email" id="email-modal-input" name="email" placeholder="correo@ejemplo.com" autocomplete="email" required>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" data-modal-cancel>Cancelar</button>
                <button type="submit" class="btn-primary" data-modal-confirm>Compartir</button>
            </div>
        </form>
    </div>

    <script>
        const PARTIDA_ID = "{{ id_partida }}";

        async function cargarReporte() {
            if (!PARTIDA_ID) {
                alert('No se proporciono un id_partida valido.');
                return;
            }
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(`/api/report/partida?id_partida=${encodeURIComponent(PARTIDA_ID)}`);
                const result = await response.json();

                if (!result.ok) {
                    alert('Error: ' + result.msg);
                    return;
                }

                const data = result.data;
                mostrarDatos(data);

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar el reporte');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function irADashboard() {
            window.location.href = '/dashboard';
        }

        function mostrarDatos(data) {
            // Header
            const header = data.header;
            const estadoMap = {
                'F': 'Finalizado',
                'E': 'En espera',
                'P': 'En progreso'
            };
            const estadoTexto = estadoMap[header.estado] || header.estado;
            document.getElementById('header-info').innerHTML = `
                <p><strong>PIN:</strong> ${header.pin} | 
                   <strong>Cuestionario:</strong> ${header.cuestionario_titulo} | 
                   <strong>Estado:</strong> ${estadoTexto}</p>
            `;

            // Resumen global
            const resumen = data.resumen;
            document.getElementById('resumen-global').innerHTML = `
                <p>Participantes: ${resumen.total_participantes} | 
                   Preguntas: ${resumen.preguntas_distintas} | 
                   Respuestas totales: ${resumen.respuestas_totales} | 
                   Acierto global: ${resumen.acierto_global}% | 
                   Tiempo promedio: ${resumen.tiempo_promedio_seg}s</p>
            `;

            // Ranking
            const tbodyRanking = document.querySelector('#tabla-ranking tbody');
            tbodyRanking.innerHTML = '';
            data.participantes.forEach((p, idx) => {
                const total = parseInt(p.correctas) + parseInt(p.incorrectas);
                const pct = total > 0 ? ((p.correctas / total) * 100).toFixed(2) : 0;
                const grupoNumero = parseInt(p.grupo || 0, 10);
                const grupoTexto = grupoNumero > 0 ? grupoNumero : 'No';
                const monedas = parseInt(p.monedas ?? 0, 10);
                tbodyRanking.innerHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${grupoTexto}</td>
                        <td>${p.nombre}</td>
                        <td>${p.puntaje_total}</td>
                        <td>${monedas}</td>
                        <td>${p.correctas}</td>
                        <td>${p.incorrectas}</td>
                        <td>${pct}%</td>
                        <td>${parseFloat(p.tiempo_prom_seg || 0).toFixed(2)}</td>
                    </tr>
                `;
            });

            // Preguntas
            const tbodyPreguntas = document.querySelector('#tabla-preguntas tbody');
            tbodyPreguntas.innerHTML = '';
            data.preguntas.forEach(preg => {
                tbodyPreguntas.innerHTML += `
                    <tr>
                        <td>${preg.id_pregunta}</td>
                        <td>${preg.pregunta_texto}</td>
                        <td>${preg.opcion_correcta || 'N/A'}</td>
                        <td>${preg.porcentaje_acierto}%</td>
                        <td>${preg.tiempo_promedio_seg}</td>
                        <td>${preg.respuestas}</td>
                    </tr>
                `;
            });
        }

        function showEmailModal({ titulo, mensaje, placeholder, confirmText }) {
            const overlay = document.getElementById('email-modal');
            const form = overlay.querySelector('form');
            const titleEl = document.getElementById('email-modal-title');
            const messageEl = document.getElementById('email-modal-message');
            const inputEl = document.getElementById('email-modal-input');
            const errorEl = document.getElementById('email-modal-error');
            const cancelBtn = overlay.querySelector('[data-modal-cancel]');
            const confirmBtn = overlay.querySelector('[data-modal-confirm]');

            titleEl.textContent = titulo;
            messageEl.textContent = mensaje;
            inputEl.placeholder = placeholder || 'correo@ejemplo.com';
            confirmBtn.textContent = confirmText || 'Compartir';
            inputEl.value = '';
            errorEl.textContent = '';

            return new Promise(resolve => {
                const closeModal = (value) => {
                    overlay.classList.remove('visible');
                    overlay.setAttribute('aria-hidden', 'true');
                    overlay.removeEventListener('click', onOverlayClick);
                    cancelBtn.removeEventListener('click', onCancel);
                    form.removeEventListener('submit', onSubmit);
                    resolve(value);
                };

                const onOverlayClick = (event) => {
                    if (event.target === overlay) {
                        closeModal(null);
                    }
                };

                const onCancel = () => closeModal(null);

                const onSubmit = (event) => {
                    event.preventDefault();
                    if (!inputEl.value.trim()) {
                        errorEl.textContent = 'Debes ingresar un correo electronico valido.';
                        inputEl.focus();
                        return;
                    }
                    closeModal(inputEl.value.trim());
                };

                overlay.addEventListener('click', onOverlayClick);
                cancelBtn.addEventListener('click', onCancel);
                form.addEventListener('submit', onSubmit);

                overlay.classList.add('visible');
                overlay.setAttribute('aria-hidden', 'false');
                setTimeout(() => inputEl.focus(), 50);
            });
        }

        function exportarExcel() {
            if (!PARTIDA_ID) {
                alert('No se proporciono un id_partida valido.');
                return;
            }
            window.location.href = `/api/report/partida/export?id_partida=${encodeURIComponent(PARTIDA_ID)}`;
        }

        async function exportarOneDrive() {
            const btn = event.target;
            const textoOriginal = btn.textContent;

            const correo = await showEmailModal({
                titulo: 'Compartir en OneDrive',
                mensaje: 'Ingresa el correo con quien deseas compartir el reporte. El archivo se subira a OneDrive y se compartira automaticamente con este correo.',
                placeholder: 'usuario@ejemplo.com',
                confirmText: 'Compartir'
            });

            if (!correo || correo.trim() === '') {
                alert('Operacion cancelada. Debes ingresar un correo electronico valido');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(correo.trim())) {
                alert('El correo electronico no tiene un formato valido');
                return;
            }

            try {
                btn.disabled = true;
                btn.textContent = 'Subiendo a OneDrive...';

                const response = await fetch(`/api/report/partida/export-onedrive?id_partida=${PARTIDA_ID}&email=${encodeURIComponent(correo.trim())}`);
                const result = await response.json();

                if (result.ok) {
                    let mensaje = `${result.msg}\n\nArchivo: ${result.file_name}\nCompartido con: ${result.shared_with || correo}`;

                    if (result.warning) {
                        mensaje += `\n\nAdvertencia: ${result.warning}`;
                    }

                    mensaje += `\n\nEl archivo se abrira en una nueva pestana`;

                    alert(mensaje);
                    window.open(result.web_url, '_blank');
                } else {
                    alert(`Error: ${result.msg}`);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al subir a OneDrive: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = textoOriginal;
            }
        }

        async function exportarDrive() {
            const btn = event.target;
            const textoOriginal = btn.textContent;

            const correo = await showEmailModal({
                titulo: 'Compartir en Google Drive',
                mensaje: 'Ingresa el correo de Gmail con quien deseas compartir el reporte. El archivo se subira a Google Drive y se compartira automaticamente con este correo.',
                placeholder: 'usuario@gmail.com',
                confirmText: 'Compartir'
            });

            if (!correo || correo.trim() === '') {
                alert('Operacion cancelada. Debes ingresar un correo electronico valido');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(correo.trim())) {
                alert('El correo electronico no tiene un formato valido');
                return;
            }

            try {
                btn.disabled = true;
                btn.textContent = 'Subiendo a Drive...';

                const response = await fetch(`/api/report/partida/export-drive?id_partida=${PARTIDA_ID}&email=${encodeURIComponent(correo.trim())}`);
                const result = await response.json();

                if (result.ok) {
                    let mensaje = `${result.msg}\n\nArchivo: ${result.file_name}\nCompartido con: ${result.shared_with || correo}`;

                    if (result.warning) {
                        mensaje += `\n\nAdvertencia: ${result.warning}`;
                    }

                    mensaje += `\n\nEl archivo se abrira en una nueva pestana`;

                    alert(mensaje);
                    window.open(result.web_view_link, '_blank');
                } else {
                    alert(`Error: ${result.msg}`);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al subir a Google Drive: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = textoOriginal;
            }
        }

        cargarReporte();
    </script>
</body>

</html>
