<!DOCTYPE html>
<html>

<head>
    <title>Jugando - {{ pin }}</title>
</head>

<body>
    <h1>Partida: {{ pin }}</h1>
    <div id="estado">Cargando pregunta...</div>

    <div id="pregunta-container" style="display: none;">
        <h2 id="pregunta-texto"></h2>
        <img id="pregunta-imagen" src="" style="display:none; max-width: 400px; margin-top: 10px;">
        <div id="opciones-lista"></div>
        <p>Tiempo: <span id="tiempo"></span>s</p>
    </div>

    <div id="resultados-container" style="display: none;">
        <h3>Resultados de la Pregunta</h3>
        <p>La respuesta correcta era: <strong id="respuesta-correcta-texto">---</strong></p>
        <h4>Ranking Actual:</h4>
        <ol id="ranking-lista"></ol>
    </div>

    <div id="final-container" style="display: none;">
        <h2>¡Juego Terminado!</h2>
        <h4>Ranking Final:</h4>
        <ol id="ranking-final-lista"></ol>
    </div>

    <div id="extra"></div>

    <script>
        const pin = "{{ pin }}";
        let tiempoRestante = 0;
        let timerInterval;
        let lastQuestionIndex = -2;

        function enviarRespuesta(idOpcion) {
            clearInterval(timerInterval);
            fetch('/api/game/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin, id_opcion: idOpcion, tiempo_restante: tiempoRestante })
            }).catch(console.error);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('estado').textContent = 'Respuesta enviada. Esperando resultados...';
        }

        function iniciarTimer(duracion, started_at, server_time) {
            const now = Date.now() / 1000.0;
            const serverNow = server_time || now;
            const diff = now - serverNow; // client-server offset approx
            const elapsed = Math.max(0, (now - diff) - started_at);
            tiempoRestante = Math.max(0, Math.floor(duracion - elapsed));
            const tiempoDisplay = document.getElementById('tiempo');
            tiempoDisplay.textContent = tiempoRestante;
            timerInterval = setInterval(() => {
                tiempoRestante--;
                tiempoDisplay.textContent = tiempoRestante;
                if (tiempoRestante <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function renderQuestion(data) {
            document.getElementById('estado').textContent = `Pregunta ${data.index + 1}`;
            document.getElementById('pregunta-texto').textContent = data.texto;
            const opcionesLista = document.getElementById('opciones-lista');
            opcionesLista.innerHTML = '';
            (data.opciones || []).forEach(op => {
                opcionesLista.innerHTML += `<button onclick="enviarRespuesta(${op.id})">${op.texto}</button><br>`;
            });

            const imgEl = document.getElementById('pregunta-imagen');
            if (data.adjunto) {
                imgEl.src = "/static/" + data.adjunto;
                imgEl.style.display = 'block';
            } else {
                imgEl.src = "";
                imgEl.style.display = 'none';
            }

            document.getElementById('resultados-container').style.display = 'none';
            document.getElementById('pregunta-container').style.display = 'block';
            iniciarTimer(data.tiempo, data.started_at, data.server_time);
        }

        function renderResults(data) {
            clearInterval(timerInterval);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('final-container').style.display = 'none';
            document.getElementById('respuesta-correcta-texto').textContent = data.texto_opcion_correcta || '---';
            const rankingLista = document.getElementById('ranking-lista');
            rankingLista.innerHTML = '';
            (data.ranking || []).forEach(item => {
                rankingLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });
            document.getElementById('resultados-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Esperando siguiente pregunta...';
        }

        function renderFinal(data) {
            clearInterval(timerInterval);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('resultados-container').style.display = 'none';
            const rankingFinalLista = document.getElementById('ranking-final-lista');
            const extraDiv = document.getElementById('extra');
            rankingFinalLista.innerHTML = '';
            (data || []).forEach(item => {
                rankingFinalLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });
            document.getElementById('final-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Fin del juego.';
            extraDiv.innerHTML = `<a href="{{ url_for('dashboard') }}">Volver a la página</a>`;
        }

        async function pollCurrent() {
            try {
                const res = await fetch(`/api/game/current?pin=${encodeURIComponent(pin)}`);
                if (!res.ok) return;
                const cur = await res.json();
                if (cur.estado === 'F' || cur.fase === 'final') {
                    renderFinal(cur.data);
                    return;
                }
                if (cur.fase === 'question') {
                    if (cur.data && cur.data.index !== lastQuestionIndex) {
                        lastQuestionIndex = cur.data.index;
                        clearInterval(timerInterval);
                        renderQuestion(cur.data);
                    }
                } else if (cur.fase === 'results') {
                    renderResults(cur.data || {});
                }
            } catch (e) { console.error(e); }
        }

        async function joinGame() {
            try {
                await fetch('/api/player/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
            } catch (e) { }
        }

        joinGame();
        setInterval(pollCurrent, 1000);
    </script>
</body>

</html>