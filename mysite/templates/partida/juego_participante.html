<!DOCTYPE html>
<html>

<head>
    <title>Jugando - {{ pin }}</title>
</head>

<body>
    <h1>Partida: {{ pin }}</h1>
    <div id="estado">Cargando pregunta...</div>

    <div id="pregunta-container" style="display: none;">
        <h2 id="pregunta-texto"></h2>
        <img id="pregunta-imagen" src="" style="display:none; max-width: 400px; margin-top: 10px;">
        <div id="opciones-lista"></div>
        <p>Tiempo: <span id="tiempo"></span>s</p>
    </div>

    <div id="resultados-container" style="display: none;">
        <h3>Resultados de la Pregunta</h3>
        <p>La respuesta correcta era: <strong id="respuesta-correcta-texto">---</strong></p>
        <h4>Ranking Actual:</h4>
        <ol id="ranking-lista"></ol>
    </div>

    <div id="final-container" style="display: none;">
        <h2>¡Juego Terminado!</h2>
        <h4>Ranking Final:</h4>
        <ol id="ranking-final-lista"></ol>
    </div>

    <div id="extra"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const pin = "{{ pin }}";
        let tiempoRestante = 0;
        let timerInterval;

        function enviarRespuesta(idOpcion) {
            clearInterval(timerInterval);
            socket.emit('enviar_respuesta', { pin: pin, id_opcion: idOpcion, tiempo_restante: tiempoRestante });
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('estado').textContent = 'Respuesta enviada. Esperando resultados...';
        }

        function iniciarTimer(duracion) {
            tiempoRestante = duracion;
            const tiempoDisplay = document.getElementById('tiempo');
            tiempoDisplay.textContent = tiempoRestante;
            timerInterval = setInterval(() => {
                tiempoRestante--;
                tiempoDisplay.textContent = tiempoRestante;
                if (tiempoRestante <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        socket.on('connect', () => {
            socket.emit('unirse_como_jugador', { pin: pin })
        });

        socket.on('nueva_pregunta', (data) => {
            document.getElementById('estado').textContent = `Pregunta ${data.index + 1}`;
            document.getElementById('pregunta-texto').textContent = data.texto;
            const opcionesLista = document.getElementById('opciones-lista');
            opcionesLista.innerHTML = '';
            data.opciones.forEach(op => {
                opcionesLista.innerHTML += `<button onclick="enviarRespuesta(${op.id})">${op.texto}</button><br>`;
            });

            const imgEl = document.getElementById('pregunta-imagen');
            if (data.adjunto) {
                imgEl.src = "/static/" + data.adjunto; // Asumiendo que está en /static/
                imgEl.style.display = 'block';
            } else {
                imgEl.src = "";
                imgEl.style.display = 'none';
            }

            document.getElementById('resultados-container').style.display = 'none';
            document.getElementById('pregunta-container').style.display = 'block';
            iniciarTimer(data.tiempo);
        });

        socket.on('mostrar_resultados', (data) => {
            clearInterval(timerInterval);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('final-container').style.display = 'none';

            // ESTA LÍNEA ES LA QUE DABA ERROR (aprox. línea 71)
            document.getElementById('respuesta-correcta-texto').textContent = data.texto_opcion_correcta;

            const rankingLista = document.getElementById('ranking-lista');
            rankingLista.innerHTML = '';
            data.ranking.forEach(item => {
                rankingLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });

            document.getElementById('resultados-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Esperando siguiente pregunta...';
        });

        socket.on('juego_finalizado', (data) => {
            clearInterval(timerInterval);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('resultados-container').style.display = 'none';

            const rankingFinalLista = document.getElementById('ranking-final-lista');
            const extraDiv = document.getElementById('extra');
            rankingFinalLista.innerHTML = '';
            data.ranking.forEach(item => {
                rankingFinalLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });

            document.getElementById('final-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Fin del juego.';

            extraDiv.innerHTML = `<a href="{{ url_for('dashboard') }}">Volver a la página</a>`;
        });
    </script>
</body>

</html>