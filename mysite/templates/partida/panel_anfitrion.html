<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Anfitrion - {{ pin }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        /* ===================== */
        /* Variables             */
        /* ===================== */
        :root {
            --btn-pending-bg: #FFECD1;
            --btn-pending-text: #F77F00;
            --btn-inprogress-bg: #E6F2FF;
            --btn-inprogress-text: #1E88E5;
            --btn-submitted-bg: #F1E8FF;
            --btn-submitted-text: #8E5CF6;
            --btn-success-bg: #E8F9E9;
            --btn-success-text: #2BB673;
            --btn-failed-bg: #FFE6E6;
            --btn-failed-text: #E53935;
            --btn-expired-bg: #F5F5F5;
            --btn-expired-text: #9E9E9E;
            --main-bg: #FFF9ED;
            --panel-bg: #FFFFFF;
            --border-soft: #E0E0E0;
            --text-color: #333333;
            --text-muted: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===================== */
        /* Layout Kahoot Style   */
        /* ===================== */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--main-bg);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 1rem;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* ===================== */
        /* Pantalla de Lobby     */
        /* ===================== */
        #host-lobby-screen {
            background: var(--main-bg);
        }

        .host-header {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-color);
            text-align: center;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .host-subheader {
            font-size: 0.9rem;
            font-weight: 600;
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 1.25rem;
            padding: 0.75rem 1rem;
            background: var(--btn-inprogress-text);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .host-subheader span {
            font-weight: 800;
            color: var(--btn-pending-bg);
            letter-spacing: 3px;
            font-size: 1.25rem;
        }

        .host-body {
            flex: 1;
        }

        .player-pool-box {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-soft);
        }

        #estado-juego {
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        /* ===================== */
        /* Grid de Grupos        */
        /* ===================== */
        .groups-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .host-group-box {
            background: var(--btn-submitted-bg);
            border-radius: 8px;
            padding: 1.25rem;
            border: 2px solid var(--btn-submitted-text);
            box-shadow: 0 4px 12px rgba(142, 92, 246, 0.2);
        }

        .host-group-header {
            font-size: 1rem;
            font-weight: 700;
            color: var(--btn-submitted-text);
            text-align: center;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .host-group-members {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
            min-height: 90px;
            align-items: start;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            justify-items: center;
        }

        /* ===================== */
        /* Sin Grupo             */
        /* ===================== */
        .host-sin-grupo-container {
            background: var(--btn-inprogress-bg);
            border-radius: 8px;
            padding: 1.25rem;
            border: 2px solid var(--btn-inprogress-text);
            margin-top: 1rem;
        }

        .host-sin-grupo-container h3 {
            color: var(--btn-inprogress-text);
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .host-sin-grupo-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
            justify-items: center;
        }

        /* ===================== */
        /* Avatares              */
        /* ===================== */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            justify-items: center;
        }

        .player-avatar-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .avatar-container {
            position: relative;
            width: 65px;
            height: 65px;
        }

        .avatar-container img.avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #FFFFFF;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
            position: relative;
            z-index: 1;
        }

        .avatar-container img.marco-activo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 125%;
            height: 125%;
            object-fit: contain;
            pointer-events: none;
            z-index: 2;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.15));
        }

        .player-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-color);
            text-align: center;
            max-width: 75px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: #FFFFFF;
            padding: 0.35rem 0.6rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-soft);
        }

        /* ===================== */
        /* Ranking Panel         */
        /* ===================== */
        .ranking-panel {
            background: var(--btn-submitted-bg);
            border-radius: 8px;
            padding: 1.25rem;
            border: 2px solid var(--btn-submitted-text);
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(142, 92, 246, 0.2);
        }

        .ranking-panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--panel-bg);
            border-radius: 8px;
            border-left: 4px solid var(--btn-submitted-text);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            gap: 0.75rem;
        }

        .ranking-item.first {
            border-left-color: #FFD700;
            background: #FFFBEA;
        }

        .ranking-item.second {
            border-left-color: #C0C0C0;
            background: #F8F8F8;
        }

        .ranking-item.third {
            border-left-color: #CD7F32;
            background: #FFF5E6;
        }

        .ranking-position {
            font-size: 1.1rem;
            font-weight: 700;
            min-width: 35px;
            text-align: center;
            color: var(--text-color);
        }

        .ranking-name {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-color);
            word-break: break-word;
        }

        .ranking-score {
            font-size: 1rem;
            font-weight: 700;
            color: var(--btn-success-text);
            min-width: 70px;
            text-align: right;
        }

        .ranking-score-label {
            display: block;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .ranking-points-gained {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .ranking-points-gained.positive {
            color: var(--btn-success-text);
        }

        .ranking-points-gained.zero {
            color: var(--text-muted);
        }

        /* ===================== */
        /* Botones               */
        /* ===================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-size: 0.9rem;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            width: 100%;
            max-width: 300px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            top: 0;
            font-family: 'Poppins', sans-serif;
            color: white;
        }

        .btn:hover {
            top: 2px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            top: 6px;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: var(--btn-success-text);
        }

        .btn-primary {
            background: var(--btn-inprogress-text);
        }

        .btn-secondary {
            background: var(--btn-pending-text);
            color: white;
        }

        .btn-danger {
            background: var(--btn-failed-text);
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        .host-footer {
            margin-top: 1.25rem;
            text-align: center;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .host-footer .btn {
            flex: 0 1 auto;
            min-width: 200px;
        }

        /* ===================== */
        /* Pantalla de Pregunta  */
        /* ===================== */
        #host-question-screen {
            background: var(--main-bg);
        }

        .host-q-header {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .host-q-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .host-q-timer-box {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--btn-submitted-text);
            color: white;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 800;
        }

        .host-q-timer-box span {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #host-q-timer {
            font-size: 1.5rem;
            font-weight: 900;
        }

        .question-image {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            margin: 1rem auto;
            display: block;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-grid .btn {
            padding: 1.5rem 1rem;
            font-size: 1rem;
            min-height: 80px;
            pointer-events: none;
            max-width: none;
        }

        .btn-grid .btn:nth-child(1) {
            background: var(--btn-failed-text);
        }

        .btn-grid .btn:nth-child(2) {
            background: var(--btn-inprogress-text);
        }

        .btn-grid .btn:nth-child(3) {
            background: var(--btn-pending-text);
        }

        .btn-grid .btn:nth-child(4) {
            background: var(--btn-success-text);
        }

        #host-q-feedback {
            margin-top: 1.25rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.875rem;
            background: var(--btn-expired-bg);
            border-radius: 8px;
        }

        /* ===================== */
        /* Resultados y Final    */
        /* ===================== */
        #host-results-screen,
        #host-final-screen {
            background: var(--panel-bg);
            align-items: center;
            justify-content: center;
        }

        .results-container {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        .podium-header {
            font-size: 1.5rem;
            font-weight: 900;
            text-align: center;
            color: var(--text-color);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .correct-answer-box {
            background: var(--btn-success-bg);
            border: 3px solid var(--btn-success-text);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.25rem 0;
            text-align: center;
        }

        .correct-answer-box>div:first-child {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        #host-correct-answer {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--btn-success-text);
        }

        .podium-places {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .podium-place {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 3px solid var(--border-soft);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            gap: 0.75rem;
        }

        .podium-place:nth-child(1) {
            background: linear-gradient(135deg, #FFE082, #FFD54F);
            border-color: #FFC107;
            color: var(--text-color);
        }

        .podium-place:nth-child(2) {
            background: linear-gradient(135deg, #E0E0E0, #BDBDBD);
            border-color: #9E9E9E;
            color: var(--text-color);
        }

        .podium-place:nth-child(3) {
            background: linear-gradient(135deg, #FFCC80, #FFB74D);
            border-color: #FF9800;
            color: var(--text-color);
        }

        .podium-rank {
            font-size: 1.2rem;
            font-weight: 900;
            min-width: 40px;
            text-align: center;
        }

        .podium-name {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 800;
        }

        .podium-score {
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--btn-success-text);
        }

        /* ===================== */
        /* Media Queries         */
        /* ===================== */

        /* Tablets (768px+) */
        @media (min-width: 768px) {
            .screen {
                padding: 2rem;
            }

            .host-header {
                font-size: 1.85rem;
            }

            .host-subheader {
                font-size: 1rem;
                padding: 0.875rem 1.25rem;
            }

            .player-pool-box {
                padding: 2rem;
            }

            .groups-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.25rem;
            }

            .host-group-box,
            .ranking-panel {
                padding: 1.5rem;
            }

            .host-group-header,
            .ranking-panel-title {
                font-size: 1.1rem;
            }

            .host-group-members,
            .host-sin-grupo-list,
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 1.25rem;
            }

            .avatar-container {
                width: 75px;
                height: 75px;
            }

            .player-name {
                font-size: 0.75rem;
                max-width: 80px;
            }

            .btn {
                font-size: 0.95rem;
                padding: 1.125rem 2.5rem;
            }

            .btn-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .btn-grid .btn {
                font-size: 1.1rem;
                padding: 2rem 1.5rem;
                min-height: 100px;
            }

            .host-q-header {
                padding: 2rem;
            }

            .host-q-header h2 {
                font-size: 1.5rem;
            }

            #host-q-timer {
                font-size: 2rem;
            }

            .question-image {
                max-height: 250px;
            }

            .podium-header {
                font-size: 2rem;
            }

            #host-correct-answer {
                font-size: 1.5rem;
            }

            .podium-place {
                padding: 1.25rem 1.5rem;
            }

            .podium-rank {
                font-size: 1.5rem;
            }

            .podium-name {
                font-size: 1.1rem;
            }

            .podium-score {
                font-size: 1.3rem;
            }
        }

        /* Desktop (1024px+) */
        @media (min-width: 1024px) {
            .container {
                max-width: 1200px;
            }

            .screen {
                padding: 3rem;
            }

            .host-header {
                font-size: 2.15rem;
            }

            .host-subheader {
                font-size: 1.1rem;
            }

            .groups-grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 1.5rem;
            }

            .host-group-members,
            .host-sin-grupo-list,
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                gap: 1.5rem;
            }

            .avatar-container {
                width: 80px;
                height: 80px;
            }

            .player-name {
                font-size: 0.8rem;
                max-width: 85px;
            }

            .btn {
                font-size: 1rem;
            }

            .btn-grid .btn {
                font-size: 1.3rem;
                padding: 2.5rem 2rem;
                min-height: 120px;
            }

            .host-q-header {
                padding: 2.5rem;
            }

            .host-q-header h2 {
                font-size: 1.75rem;
            }

            #host-q-timer {
                font-size: 2.5rem;
            }

            .question-image {
                max-height: 300px;
            }

            .podium-header {
                font-size: 2.5rem;
            }

            #host-correct-answer {
                font-size: 1.75rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- PANTALLA DE LOBBY DEL HOST -->
        <div id="host-lobby-screen" class="screen active">
            <div class="host-header">Panel de Anfitrion</div>
            <div class="host-subheader">PIN: <span>{{ pin }}</span></div>
            <div class="host-body">
                <div class="ranking-panel" id="ranking-panel-lobby" style="display:none;">
                    <div class="ranking-panel-title">Ranking Actual</div>
                    <div id="ranking-list-lobby" class="ranking-list"></div>
                </div>
                <div class="player-pool-box">
                    <p id="estado-juego">Esperando jugadores...</p>
                    <div id="grupos-container" class="groups-grid"></div>
                    <div id="sin-grupo-container" class="host-sin-grupo-container" style="display:none;">
                        <h3>Sin grupo (Esperando asignacion)</h3>
                        <div id="sin-grupo-list" class="host-sin-grupo-list"></div>
                    </div>
                </div>
            </div>
            <div class="host-footer">
                <button id="btn-comenzar" class="btn btn-success" onclick="comenzarJuego()">Comenzar Juego</button>
            </div>
        </div>

        <!-- PANTALLA DE PREGUNTA DEL HOST -->
        <div id="host-question-screen" class="screen">
            <div class="host-q-header">
                <h2 id="host-q-text">Pregunta...</h2>
                <div class="host-q-timer-box">
                    <span>TIEMPO</span>
                    <div id="host-q-timer">10</div>
                </div>
            </div>
            <div class="question-section"></div>
            <div id="host-q-answer-grid" class="btn-grid"></div>
            <div id="host-q-feedback">Esperando respuestas...</div>
            <div class="ranking-panel" id="ranking-panel-question" style="margin-top: 1.5rem;">
                <div class="ranking-panel-title">Ranking Acumulado</div>
                <div id="ranking-list-question" class="ranking-list"></div>
            </div>
        </div>

        <!-- PANTALLA DE RESULTADOS DEL HOST -->
        <div id="host-results-screen" class="screen">
            <div class="results-container">
                <div class="podium-header">Resultados de la Pregunta</div>

                <div class="correct-answer-box">
                    <div>Respuesta Correcta</div>
                    <div id="host-correct-answer"></div>
                </div>

                <div class="podium-header" style="font-size: 1.25rem; margin-top: 1.5rem;">Ranking Actual</div>
                <div id="ranking"></div>

                <div
                    style="text-align: center; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;">
                    Siguiente pregunta en breve...
                </div>
            </div>
        </div>

        <!-- PANTALLA FINAL DEL HOST -->
        <div id="host-final-screen" class="screen">
            <div style="max-width: 700px; margin: 0 auto; width: 100%;">
                <div class="podium-header">Juego Finalizado</div>
                <div class="podium-header" style="margin-top:1.5rem; font-size: 1.25rem;">Ranking Final</div>
                <div id="ranking-final" style="padding:1rem 0;"></div>
                <div id="extra" style="margin-top:1.5rem; text-align: center;"></div>
            </div>
        </div>
    </div>

    <script>
        const pin = "{{ pin }}";
        let pollLobbyInterval = null;
        let pollGameInterval = null;

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        async function comenzarJuego() {
            try {
                const res1 = await fetch(`/api/lobby/state?pin=${encodeURIComponent(pin)}`);
                const lobby = await res1.json();

                const sinGrupo = (lobby.participantes_sin_grupo || []).length;

                if (sinGrupo > 0 && lobby.modalidad_grupal) {
                    console.warn(`${sinGrupo} participante${sinGrupo > 1 ? 's' : ''} sin grupo sera${sinGrupo > 1 ? 'n' : ''} asignado${sinGrupo > 1 ? 's' : ''} aleatoriamente`);

                    const feedback = document.getElementById('host-q-feedback');
                    if (feedback) {
                        feedback.textContent = `Auto-asignando ${sinGrupo} participante${sinGrupo > 1 ? 's' : ''} a grupos aleatorios...`;
                        feedback.style.background = 'var(--btn-success-bg)';
                        feedback.style.color = 'var(--btn-success-text)';
                    }
                }

                const res = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                if (data.started) {
                    if (pollLobbyInterval) clearInterval(pollLobbyInterval);
                    startGamePolling();
                } else {
                    alert("No se puede iniciar sin jugadores")
                }
            } catch (e) {
                console.error('Error al iniciar juego', e);
            }
        }

        function renderLobby(lobby) {
            const gruposContainer = document.getElementById('grupos-container');
            const sinGrupoContainer = document.getElementById('sin-grupo-container');
            const sinGrupoList = document.getElementById('sin-grupo-list');
            const estadoJuego = document.getElementById('estado-juego');

            gruposContainer.innerHTML = '';

            let totalParticipantes = 0;

            if (lobby.modalidad_grupal) {
                if (Array.isArray(lobby.grupos) && lobby.grupos.length > 0) {
                    lobby.grupos.forEach(g => {
                        const card = document.createElement('div');
                        card.className = 'host-group-box';

                        let membersHTML = '';
                        if (Array.isArray(g.miembros) && g.miembros.length > 0) {
                            membersHTML = g.miembros.map(m => {
                                const nombre = typeof m === 'string' ? m : m.nombre;
                                const foto = typeof m === 'object' ? m.foto : 'img/ico.png';
                                const skin = typeof m === 'object' ? m.skin : null;
                                return `
                                    <div class="player-avatar-wrap">
                                        <div class="avatar-container">
                                            <img src="/static/${foto}" class="avatar" alt="${nombre}">
                                            ${skin ? `<img src="/static/${skin}" class="marco-activo" alt="Skin">` : ''}
                                        </div>
                                        <span class="player-name">${nombre}</span>
                                    </div>
                                `;
                            }).join('');
                            totalParticipantes += g.miembros.length;
                        } else {
                            membersHTML = '<p style="color:var(--text-muted); font-size:0.8rem; text-align:center; grid-column: 1/-1;">Vacio</p>';
                        }

                        card.innerHTML = `
                            <div class="host-group-header">${g.nombre}</div>
                            <div class="host-group-members">${membersHTML}</div>
                        `;
                        gruposContainer.appendChild(card);
                    });
                }

                if (Array.isArray(lobby.participantes_sin_grupo) && lobby.participantes_sin_grupo.length > 0) {
                    sinGrupoContainer.style.display = 'block';
                    sinGrupoList.innerHTML = '';
                    lobby.participantes_sin_grupo.forEach(p => {
                        const nombre = typeof p === 'string' ? p : p.nombre;
                        const foto = typeof p === 'object' ? p.foto : 'img/ico.png';
                        const skin = typeof p === 'object' ? p.skin : null;

                        const playerDiv = document.createElement('div');
                        playerDiv.className = 'player-avatar-wrap';
                        playerDiv.innerHTML = `
                            <div class="avatar-container">
                                <img src="/static/${foto}" class="avatar" alt="${nombre}">
                                ${skin ? `<img src="/static/${skin}" class="marco-activo" alt="Skin">` : ''}
                            </div>
                            <span class="player-name">${nombre}</span>
                        `;
                        sinGrupoList.appendChild(playerDiv);
                    });
                    totalParticipantes += lobby.participantes_sin_grupo.length;
                } else {
                    sinGrupoContainer.style.display = 'none';
                }

            } else {
                if (Array.isArray(lobby.grupos) && lobby.grupos.length > 0 && lobby.grupos[0].miembros) {
                    totalParticipantes = lobby.grupos[0].miembros.length;

                    const card = document.createElement('div');
                    card.className = 'host-group-box';

                    let membersHTML = '';
                    if (totalParticipantes > 0) {
                        membersHTML = lobby.grupos[0].miembros.map(m => {
                            const nombre = typeof m === 'string' ? m : m.nombre;
                            const foto = typeof m === 'object' ? m.foto : 'img/ico.png';
                            const skin = typeof m === 'object' ? m.skin : null;
                            return `
                                <div class="player-avatar-wrap">
                                    <div class="avatar-container">
                                        <img src="/static/${foto}" class="avatar" alt="${nombre}">
                                        ${skin ? `<img src="/static/${skin}" class="marco-activo" alt="Skin">` : ''}
                                    </div>
                                    <span class="player-name">${nombre}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        membersHTML = '<p style="color:var(--text-muted); font-size:0.8rem; text-align:center; grid-column: 1/-1;">Esperando jugadores...</p>';
                    }

                    card.innerHTML = `
                        <div class="host-group-header">Participantes</div>
                        <div class="host-group-members">${membersHTML}</div>
                    `;
                    gruposContainer.appendChild(card);
                }
                sinGrupoContainer.style.display = 'none';
            }

            if (totalParticipantes === 0) {
                estadoJuego.textContent = 'Esperando que se unan jugadores...';
            } else {
                estadoJuego.textContent = `${totalParticipantes} jugador${totalParticipantes !== 1 ? 'es' : ''} conectado${totalParticipantes !== 1 ? 's' : ''}`;
            }
        }

        function renderRanking(data) {
            if (!data || !Array.isArray(data)) {
                return;
            }

            const rankingListQuestion = document.getElementById('ranking-list-question');
            if (rankingListQuestion) {
                rankingListQuestion.innerHTML = '';
                data.slice(0, 5).forEach((item, idx) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item';
                    if (idx === 0) rankingItem.classList.add('first');
                    else if (idx === 1) rankingItem.classList.add('second');
                    else if (idx === 2) rankingItem.classList.add('third');

                    const puntosClase = item.puntos_ganados > 0 ? 'positive' : item.puntos_ganados === 0 ? 'zero' : 'negative';
                    const puntosTexto = item.puntos_ganados > 0 ? `+ ${item.puntos_ganados}` : item.puntos_ganados.toString();

                    rankingItem.innerHTML = `
                        <div class="ranking-position">${idx + 1}</div>
                        <div class="ranking-name">${item.nombre}</div>
                        <div class="ranking-score">
                            <div class="ranking-points-gained ${puntosClase}">${puntosTexto}</div>
                            <div class="ranking-score-label">Acumulado</div>
                            ${item.puntaje} pts
                        </div>
                    `;
                    rankingListQuestion.appendChild(rankingItem);
                });
            }
        }

        async function initHost() {
            try {
                const res = await fetch('/api/game/host/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                if (!res.ok) {
                    document.getElementById('estado-juego').textContent = 'PIN invalido';
                    return;
                }
                renderLobby(data.lobby);
                if (data.estado === 'E') {
                    // La partida est谩 en espera, mostrar bot贸n de cancelar
                    const btnCancelar = document.getElementById('btn-cancelar-partida');
                    if (btnCancelar) btnCancelar.style.display = 'inline-block';

                    pollLobbyInterval = setInterval(async () => {
                        const r = await fetch(`/api/lobby/state?pin=${encodeURIComponent(pin)}`);
                        const l = await r.json();
                        renderLobby(l);
                    }, 1500);
                } else {
                    // El juego ya comenz贸, ocultar bot贸n de cancelar
                    const btnCancelar = document.getElementById('btn-cancelar-partida');
                    if (btnCancelar) btnCancelar.style.display = 'none';

                    startGamePolling();
                }
            } catch (e) {
                console.error(e);
            }
        }

        let hostTimerInterval = null;
        let lastQuestionIndexHost = -1;

        function renderQuestion(q) {
            if (q.index !== lastQuestionIndexHost) {
                lastQuestionIndexHost = q.index;
                clearInterval(hostTimerInterval);

                switchScreen('host-question-screen');
                document.getElementById('host-q-text').textContent = q.texto;

                //const questionSection = document.querySelector('#host-question-screen .question-section');
                //const existingImg = questionSection ? questionSection.querySelector('.question-image') : null;
                //if (existingImg) existingImg.remove();
                //TEST EXCEL importar imagen
                /*
                                if (q.adjunto && questionSection) {
                                    const img = document.createElement('img');
                                    img.src = `/static/${q.adjunto}`;
                                    img.className = 'question-image';
                                    questionSection.appendChild(img);
                                }
                */
                const questionSection = document.querySelector('#host-question-screen .question-section');
                const existingImg = questionSection ? questionSection.querySelector('.question-image') : null;
                if (existingImg) existingImg.remove();

                if (q.adjunto && typeof q.adjunto === 'string' && questionSection) { // Asegurarse que no sea nulo y que la secci贸n exista
                    const img = document.createElement('img');

                    if (q.adjunto.startsWith('http://') || q.adjunto.startsWith('https://')) {
                        img.src = q.adjunto;
                    } else {
                        img.src = '/static/' + q.adjunto;
                    }

                    img.className = 'question-image';
                    questionSection.appendChild(img);
                }

                const grid = document.getElementById('host-q-answer-grid');
                grid.innerHTML = '';
                (q.opciones || []).forEach(op => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary';
                    btn.textContent = op.texto;
                    grid.appendChild(btn);
                });

                const now = Date.now() / 1000.0;
                const serverNow = q.server_time || now;
                const diff = now - serverNow;
                const elapsed = Math.max(0, (now - diff) - q.started_at);
                let tiempoRestante = Math.max(0, Math.ceil(q.tiempo - elapsed));

                document.getElementById('host-q-timer').textContent = tiempoRestante;

                hostTimerInterval = setInterval(() => {
                    tiempoRestante--;
                    document.getElementById('host-q-timer').textContent = Math.max(0, tiempoRestante);
                    if (tiempoRestante <= 0) {
                        clearInterval(hostTimerInterval);
                    }
                }, 1000);
            }
        }

        function renderResults(r) {
            clearInterval(hostTimerInterval);
            switchScreen('host-results-screen');

            const correctAnswerDiv = document.getElementById('host-correct-answer');
            if (r && r.texto_opcion_correcta) {
                correctAnswerDiv.textContent = r.texto_opcion_correcta;
            } else {
                correctAnswerDiv.textContent = 'N/A';
            }

            const rankingDiv = document.getElementById('ranking');
            rankingDiv.innerHTML = '<div class="podium-places">';

            if (r && r.ranking && Array.isArray(r.ranking)) {
                r.ranking.forEach((item, idx) => {
                    rankingDiv.innerHTML += `
                        <div class="podium-place">
                            <div class="podium-rank">${idx + 1}</div>
                            <div class="podium-name">${item.nombre}</div>
                            <div class="podium-score">${item.puntaje} pts</div>
                        </div>
                    `;
                });
            } else {
                rankingDiv.innerHTML += '<p style="text-align: center; color: var(--text-muted); padding: 1rem;">No hay datos de ranking</p>';
            }

            rankingDiv.innerHTML += '</div>';
        }

        function renderFinal(r) {
            switchScreen('host-final-screen');
            const rankingDiv = document.getElementById('ranking-final');
            const extraDiv = document.getElementById('extra');
            rankingDiv.innerHTML = '<div class="podium-places">';

            console.log('DEBUG HOST: Datos finales recibidos:', r);

            (r || []).forEach((item, idx) => {
                const monedasMostrar = item.monedas !== undefined ? item.monedas : 0;
                rankingDiv.innerHTML += `
                    <div class="podium-place">
                        <div class="podium-rank">${idx + 1}</div>
                        <div class="podium-name">${item.nombre}</div>
                        <div class="podium-score">
                            ${item.puntaje} pts
                            <div style="font-size: 0.85rem; margin-top: 0.3rem; color: #000; font-weight: 700;">
                                 ${monedasMostrar} monedas
                            </div>
                        </div>
                    </div>
                `;
            });
            rankingDiv.innerHTML += '</div>';
            extraDiv.innerHTML = `
                                <a href="{{ url_for('cuestionarios') }}" class="btn btn-primary">Volver a mis cuestionarios</a>
                                {% if id_partida %}
                                <a target="_blank" href="{{ url_for('reporte_partida_page', id_partida=id_partida) }}" class="btn btn-secondary" style="margin-left:10px;">Ver Reporte</a>
                                {% endif %}
                                `; <!-- Para reportes - Agregado por Pame-->
        }

        function startGamePolling() {
            pollGameInterval = setInterval(async () => {
                const res = await fetch(`/api/game/current?pin=${encodeURIComponent(pin)}`);
                const data = await res.json();

                if (!res.ok || !data.existe) return;

                if (data.estado === 'F' || data.fase === 'final') {
                    clearInterval(pollGameInterval);
                    renderFinal(data.data);
                    return;
                }

                if (data.fase === 'question' && data.data && data.data.index !== lastQuestionIndexHost) {
                    renderQuestion(data.data);
                }
                else if (data.fase === 'results' && data.data) {
                    renderResults(data.data);
                }

                if (data.ranking_actual) {
                    renderRanking(data.ranking_actual);
                }
            }, 500);
        }

        initHost();
    </script>
</body>

</html>