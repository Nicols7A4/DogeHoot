<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel de Anfitrión - {{ pin }}</title>
    <style>
        /* Estilos simples para la demo */
        body {
            font-family: sans-serif;
            text-align: center;
        }

        .grupos-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .grupo-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            min-width: 200px;
        }
    </style>
</head>

<body>
    <h1>PIN: {{ pin }}</h1>
    <div id="estado-juego">Esperando jugadores...</div>
    <ul id="lista-jugadores"></ul>
    <button id="btn-comenzar" onclick="comenzarJuego()">Comenzar Juego</button>
    <div id="ranking"></div>
    <div id="extra"></div>

    <script>
        const pin = "{{ pin }}";
        let pollLobbyInterval = null;
        let pollGameInterval = null;

        async function comenzarJuego() {
            try {
                const res = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                if (data.started) {
                    document.getElementById('btn-comenzar').style.display = 'none';
                    if (pollLobbyInterval) clearInterval(pollLobbyInterval);
                    startGamePolling();
                }
            } catch (e) {
                console.error('Error al iniciar juego', e);
            }
        }

        function renderLobby(lobby) {
            const lista = document.getElementById('lista-jugadores');
            lista.innerHTML = '';
            let jugadores = Array.isArray(lobby.participantes_sin_grupo) ? lobby.participantes_sin_grupo.slice() : [];
            (lobby.grupos || []).forEach(g => { jugadores = jugadores.concat(g.miembros || []); });
            jugadores.forEach(j => { lista.innerHTML += `<li>${j}</li>`; });
        }

        async function initHost() {
            try {
                const res = await fetch('/api/game/host/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                if (!res.ok) {
                    document.getElementById('estado-juego').textContent = 'PIN inválido';
                    return;
                }
                renderLobby(data.lobby);
                if (data.estado === 'E') {
                    pollLobbyInterval = setInterval(async () => {
                        const r = await fetch(`/api/lobby/state?pin=${encodeURIComponent(pin)}`);
                        const l = await r.json();
                        renderLobby(l);
                    }, 1500);
                } else {
                    document.getElementById('btn-comenzar').style.display = 'none';
                    startGamePolling();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderQuestion(q) {
            document.getElementById('estado-juego').textContent = `Pregunta ${q.index + 1}: ${q.texto}`;
            document.getElementById('ranking').innerHTML = '';
        }

        function renderResults(r) {
            document.getElementById('estado-juego').textContent = 'Mostrando resultados...';
            const rankingDiv = document.getElementById('ranking');
            rankingDiv.innerHTML = '<h4>Ranking Actual:</h4><ol>';
            (r.ranking || []).forEach(item => {
                rankingDiv.innerHTML += `<li>${item.nombre}: ${item.puntaje} puntos</li>`;
            });
            rankingDiv.innerHTML += '</ol>';
        }

        function renderFinal(r) {
            document.getElementById('estado-juego').textContent = '¡Juego Finalizado!';
            const rankingDiv = document.getElementById('ranking');
            const extraDiv = document.getElementById('extra');
            rankingDiv.innerHTML = '<h2>Ranking Final:</h2><ol>';
            (r || []).forEach(item => {
                rankingDiv.innerHTML += `<li>${item.nombre}: ${item.puntaje} puntos</li>`;
            });
            rankingDiv.innerHTML += '</ol>';
            extraDiv.innerHTML = `<a href="{{ url_for('cuestionarios') }}">Volver a mis cuestionarios</a>`;
        }

        function startGamePolling() {
            pollGameInterval = setInterval(async () => {
                const res = await fetch(`/api/game/current?pin=${encodeURIComponent(pin)}`);
                const data = await res.json();
                if (!res.ok || !data.existe) return;
                if (data.estado === 'F' || data.fase === 'final') {
                    clearInterval(pollGameInterval);
                    renderFinal(data.data);
                    return;
                }
                if (data.fase === 'question') renderQuestion(data.data);
                if (data.fase === 'results') renderResults(data.data);
            }, 1000);
        }

        // init
        initHost();
    </script>
</body>

</html>