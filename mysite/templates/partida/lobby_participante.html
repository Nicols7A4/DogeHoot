<!-- <!DOCTYPE html>
<html>

<head>
    <title>Jugando - {{ pin }}</title>
</head>

<body>
    <h1>Partida: {{ pin }}</h1>
    <div id="estado">Esperando inicio...</div>
    <div id="pregunta-container" style="display: none;">
        <h2 id="pregunta-texto"></h2>
        <div id="opciones-lista"></div>
        <p>Tiempo restante: <span id="tiempo"></span>s</p>
    </div>
    <div id="resultados-container" style="display: none;">
        <h3>Resultados de la Pregunta</h3>
        <p>La respuesta correcta era: <span id="respuesta-correcta-texto"></span></p>
        <h4>Ranking Actual:</h4>
        <ol id="ranking-lista"></ol>
    </div>
    <div id="final-container" style="display: none;">
        <h2>¡Juego Terminado!</h2>
        <h4>Ranking Final:</h4>
        <ol id="ranking-final-lista"></ol>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const pin = "{{ pin }}";
        let tiempoRestante = 0;
        let timerInterval;

        function enviarRespuesta(idOpcion) {
            clearInterval(timerInterval); // Detiene el timer al responder
            socket.emit('enviar_respuesta', { pin: pin, id_opcion: idOpcion, tiempo_restante: tiempoRestante });
            document.getElementById('pregunta-container').style.display = 'none'; // Oculta pregunta
            document.getElementById('estado').textContent = 'Respuesta enviada. Esperando resultados...';
        }

        function iniciarTimer(duracion) {
            tiempoRestante = duracion;
            const tiempoDisplay = document.getElementById('tiempo');
            tiempoDisplay.textContent = tiempoRestante;
            timerInterval = setInterval(() => {
                tiempoRestante--;
                tiempoDisplay.textContent = tiempoRestante;
                if (tiempoRestante <= 0) {
                    clearInterval(timerInterval);
                    // Opcional: enviar respuesta vacía o simplemente esperar resultados
                }
            }, 1000);
        }

        socket.on('connect', () => socket.emit('unirse_como_jugador', { pin: pin }));

        socket.on('nueva_pregunta', (data) => {
            document.getElementById('estado').textContent = `Pregunta ${data.index + 1}`;
            document.getElementById('pregunta-texto').textContent = data.texto;
            const opcionesLista = document.getElementById('opciones-lista');
            opcionesLista.innerHTML = '';
            data.opciones.forEach(op => {
                opcionesLista.innerHTML += `<button onclick="enviarRespuesta(${op.id})">${op.texto}</button><br>`;
            });
            document.getElementById('resultados-container').style.display = 'none';
            document.getElementById('pregunta-container').style.display = 'block';
            iniciarTimer(data.tiempo);
        });

        socket.on('mostrar_resultados', (data) => {
            clearInterval(timerInterval); // Asegura que el timer se detenga
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('final-container').style.display = 'none';

            // Necesitaríamos saber el texto de la opción correcta, no solo el ID.
            // Por ahora, solo mostramos el ranking.
            document.getElementById('respuesta-correcta-texto').textContent = data.texto_opcion_correcta;

            const rankingLista = document.getElementById('ranking-lista');
            rankingLista.innerHTML = '';
            data.ranking.forEach(item => {
                rankingLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });

            document.getElementById('resultados-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Esperando siguiente pregunta...';
        });

        socket.on('juego_finalizado', (data) => {
            clearInterval(timerInterval);
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('resultados-container').style.display = 'none';

            const rankingFinalLista = document.getElementById('ranking-final-lista');
            rankingFinalLista.innerHTML = '';
            data.ranking.forEach(item => {
                rankingFinalLista.innerHTML += `<li>${item.nombre}: ${item.puntaje}</li>`;
            });

            document.getElementById('final-container').style.display = 'block';
            document.getElementById('estado').textContent = 'Fin del juego.';
        });
    </script>
</body>

</html> -->

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Sala de Espera - {{ pin }}</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
        }

        .grupos-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .grupo-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            min-width: 200px;
        }
    </style>
</head>

<body>
    <h1>¡Te has unido a la partida!</h1>
    <p>Esperando a que el anfitrión comience el juego...</p>

    <div id="lobby-container">
    </div>

    <script>
        const pin = "{{ pin }}";
        let pollLobbyInterval = null;
        let pollStatusInterval = null;

        async function unirseAGrupo(nombre_grupo) {
            try {
                await fetch('/api/player/select-group', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, nombre_grupo })
                });
            } catch (e) { console.error(e); }
        }

        function renderLobby(data) {
            const container = document.getElementById('lobby-container');
            if (data.modalidad_grupal) {
                container.innerHTML = '<h3>Elige tu grupo:</h3>';
                const gruposContainer = document.createElement('div');
                gruposContainer.className = 'grupos-container';
                (data.grupos || []).forEach(grupo => {
                    const grupoCard = document.createElement('div');
                    grupoCard.className = 'grupo-card';
                    const miembros = (grupo.miembros || []).map(m => `<li>${m}</li>`).join('');
                    grupoCard.innerHTML = `
                        <h4>${grupo.nombre}</h4>
                        <ul>${miembros}</ul>
                        <button onclick="unirseAGrupo('${grupo.nombre}')">Unirse</button>
                    `;
                    gruposContainer.appendChild(grupoCard);
                });
                container.appendChild(gruposContainer);
            } else {
                container.innerHTML = '<h3>Jugadores en la sala:</h3>';
                const lista = document.createElement('ul');
                (data.participantes_sin_grupo || []).forEach(j => { lista.innerHTML += `<li>${j}</li>`; });
                container.appendChild(lista);
            }
        }

        async function joinLobby() {
            try {
                const res = await fetch('/api/player/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                if (!res.ok) return;
                renderLobby(data.lobby);
                pollLobbyInterval = setInterval(async () => {
                    const r = await fetch(`/api/lobby/state?pin=${encodeURIComponent(pin)}`);
                    if (!r.ok) return;
                    const l = await r.json();
                    renderLobby(l);
                }, 1500);

                pollStatusInterval = setInterval(async () => {
                    const sres = await fetch(`/api/game/status?pin=${encodeURIComponent(pin)}`);
                    if (!sres.ok) return;
                    const st = await sres.json();
                    if (st.estado === 'J' && st.url) {
                        clearInterval(pollLobbyInterval);
                        clearInterval(pollStatusInterval);
                        window.location.href = st.url;
                    }
                }, 1200);
            } catch (e) { console.error(e); }
        }

        joinLobby();
    </script>
</body>

</html>